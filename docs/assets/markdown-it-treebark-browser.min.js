(function(y,b){typeof exports=="object"&&typeof module<"u"?module.exports=b():typeof define=="function"&&define.amd?define(b):(y=typeof globalThis<"u"?globalThis:y||self,y.MarkdownItTreebark=b())})(this,(function(){"use strict";const y=new Set(["div","span","p","header","footer","main","section","article","h1","h2","h3","h4","h5","h6","strong","em","blockquote","code","pre","ul","ol","li","table","thead","tbody","tr","th","td","a"]),b=new Set(["$comment","$if"]),A=new Set(["img","br","hr"]),B=new Set([...y,...b,...A]),O=new Set(["id","class","style","title","role","data-","aria-"]),D={a:new Set(["href","target","rel"]),img:new Set(["src","alt","width","height"]),table:new Set(["summary"]),th:new Set(["scope","colspan","rowspan"]),td:new Set(["scope","colspan","rowspan"]),blockquote:new Set(["cite"])},g=new Set(["$<","$>","$<=","$>=","$=","$in"]),k=new Set(["$check","$then","$else","$not","$join",...g]),N=new Set(["behavior","-moz-binding"]),U=new Set(["__proto__","constructor","prototype"]),R=new Set(["http:","https:","mailto:","tel:","sms:","ftp:","ftps:"]),G=new Set(["href","src"]);function S(e,n,o=[],r,s){if(n===".")return e;let i=e,t=n;for(;t.startsWith("..");){let c=0,a=t;for(;a.startsWith("..");)c++,a=a.substring(2),a.startsWith("/")&&(a=a.substring(1));if(c<=o.length)i=o[o.length-c],t=a.startsWith(".")?a.substring(1):a;else return s?s(n,e,o):void 0}if(t){if(r&&typeof i!="object"&&i!==null&&i!==void 0){r.error(`Cannot access property "${t}" on primitive value of type "${typeof i}"`);return}const c=t.split(".").reduce((a,l)=>{if(U.has(l)){r&&r.warn(`Access to property "${l}" is blocked for security reasons`);return}return a&&typeof a=="object"&&a!==null?a[l]:void 0},i);return c===void 0&&s?s(n,e,o):c}return i}function _(e){return e.replace(/[&<>"']/g,n=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[n]||n)}function T(e,n,o=!0,r=[],s,i){return e.replace(/\{\{\{([^{]*?)\}\}\}|\{\{([^{]*?)\}\}/g,(t,c,a)=>{if(c!==void 0)return`{{${c.trim()}}}`;const l=a.trim(),f=S(n,l,r,s,i);return f==null?"":o?_(String(f)):String(f)})}function L(e,n){const o=[];for(const[r,s]of Object.entries(e)){const i=r;if(!/^[a-z]([a-z0-9-]*[a-z0-9])?$/.test(i)){n.warn(`CSS property "${r}" has invalid format (must be kebab-case)`);continue}if(N.has(i)){n.warn(`CSS property "${r}" is blocked for security reasons`);continue}if(s==null)continue;let t=String(s).trim();if(t.includes(";")){const l=t;t=t.split(";")[0].trim(),t&&t!==l.trim()&&n.warn(`CSS value for "${r}" contained semicolon - using only first part: "${t}"`)}if(!t)continue;const c=/url\s*\(/i.test(t),a=/url\s*\(\s*['"]?data:/i.test(t);if(c&&!a||/expression\s*\(/i.test(t)||/javascript:/i.test(t)||/@import/i.test(t)){n.warn(`CSS value for "${r}" contains potentially dangerous pattern: "${t}"`);continue}o.push(`${i}: ${t}`)}return o.join("; ").trim()}function F(e,n,o,r,s){if(e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$check"in e&&typeof e.$check=="string"){const i=e;if(!w(i.$check,"$check",r))return"";const t=S(n,i.$check,o,r,s),a=j(t,i)?i.$then:i.$else;return a===void 0?"":typeof a=="object"&&a!==null&&!Array.isArray(a)?L(a,r):""}return typeof e=="object"&&e!==null&&!Array.isArray(e)?L(e,r):(r.error(`Style attribute must be an object with CSS properties, not ${typeof e}. Example: style: { "color": "red", "font-size": "14px" }`),"")}function M(e,n,o){const r=O.has(e)||[...O].some(t=>t.endsWith("-")&&e.startsWith(t)),s=D[n],i=s&&s.has(e);return!r&&!i?(o.warn(`Attribute "${e}" is not allowed on tag "${n}"`),!1):!0}function q(e,n,o){const r=n.trim();if(!r||r.startsWith("/")||r.startsWith("#")||r.startsWith("?")||!r.includes(":"))return r;const s=r.indexOf(":");if(s===-1)return r;const i=r.substring(0,s+1).toLowerCase();return R.has(i)?r:(o.warn(`Attribute "${e}" contains blocked protocol "${i}". Allowed protocols: ${[...R].join(", ")}, or relative URLs`),null)}function z(e,n,o){return G.has(e)?q(e,n,o):n}function K(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$bind"in e}function w(e,n,o){return e==="."?!0:e.includes("..")?(o.error(`${n} does not support parent context access (..) - use interpolation {{..prop}} in content/attributes instead. Invalid: ${n}: "${e}"`),!1):e.includes("{{")?(o.error(`${n} does not support interpolation {{...}} - use literal property paths only. Invalid: ${n}: "${e}"`),!1):!0}function j(e,n){const o=[];for(const t of g)t in n&&o.push({key:t,value:n[t]});if(o.length===0){const t=!!e;return n.$not?!t:t}const r=o.map(t=>{switch(t.key){case"$<":return typeof e=="number"&&typeof t.value=="number"&&e<t.value;case"$>":return typeof e=="number"&&typeof t.value=="number"&&e>t.value;case"$<=":return typeof e=="number"&&typeof t.value=="number"&&e<=t.value;case"$>=":return typeof e=="number"&&typeof t.value=="number"&&e>=t.value;case"$=":return e===t.value;case"$in":return Array.isArray(t.value)&&t.value.includes(e);default:return!1}}),s=n.$join==="OR";let i;return s?i=r.some(t=>t):i=r.every(t=>t),n.$not?!i:i}function Y(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$check"in e&&typeof e.$check=="string"}function V(e,n,o=[],r,s){if(!w(e.$check,"$check",r))return"";const i=S(n,e.$check,o,r,s);return j(i,e)?e.$then!==void 0?e.$then:"":e.$else!==void 0?e.$else:""}function J(e,n){if(!e||typeof e!="object"){n.error("Template object cannot be null, undefined, or non-object");return}const o=Object.entries(e);if(o.length===0){n.error("Template object must have at least one tag");return}const r=o[0];if(!r){n.error("Template object must have at least one tag");return}const[s,i]=r,t=typeof i=="string"?[i]:Array.isArray(i)?i:i?.$children||[],c=i&&typeof i=="object"&&!Array.isArray(i)?Object.fromEntries(Object.entries(i).filter(([a])=>a!=="$children")):{};return{tag:s,rest:i,children:t,attrs:c}}function H(e,n,o=[],r,s){const i=e;if(!i.$check)return r.error('"$if" tag requires $check attribute to specify the condition'),{valueToRender:void 0};if(!w(i.$check,"$check",r))return{valueToRender:void 0};const t=S(n,i.$check,o,r,s);typeof e=="object"&&e!==null&&!Array.isArray(e)&&"$children"in e&&r.warn('"$if" tag does not support $children, use $then and $else instead');const{$then:c,$else:a}=i;if(c!==void 0&&Array.isArray(c))return r.error('"$if" tag $then must be a string or single element object, not an array'),{valueToRender:void 0};if(a!==void 0&&Array.isArray(a))return r.error('"$if" tag $else must be a string or single element object, not an array'),{valueToRender:void 0};const f=(typeof e=="object"&&e!==null&&!Array.isArray(e)?Object.keys(e):[]).filter($=>!k.has($));return f.length>0&&r.warn(`"$if" tag does not support attributes: ${f.join(", ")}. Allowed: ${[...k].join(", ")}`),{valueToRender:j(t,i)?c:a}}const Q=(e,n)=>{if(!n)return e.length<=1?e[0]?.[1]??"":e.reduce((r,[,s])=>r+s,"");if(e.length===0)return"";if(e.length===1&&!e[0][1].includes("<"))return e[0][1];let o=`
`;for(let r=0;r<e.length;r++)o+=n.repeat(e[r][0])+e[r][1],r<e.length-1&&(o+=`
`);return o+=`
`,o};function I(e,n={}){const o=e.data,r=n.logger||console,s=n.propertyFallback,i=n.useBlockContainer!==!1,t=n.indent?{indentStr:typeof n.indent=="number"?" ".repeat(n.indent):typeof n.indent=="string"?n.indent:"  ",level:0,logger:r,getOuterProperty:s}:{logger:r,getOuterProperty:s},c=p(e.template,o,t);return i?`<div style="contain: content; isolation: isolate;" data-treebark-container="true">${c}</div>`:c}function X(e,n,o,r,s,i,t,c=[],a){const l=Q(r,i),f=l.startsWith(`
`)&&i?i.repeat(t||0):"";if(e==="$comment")return`<!--${l}${f}-->`;const d=`<${e}${Z(n,o,e,c,s,a)}>`;return A.has(e)?d:`${d}${l}${f}</${e}>`}function p(e,n,o){const r=o.parents||[],s=o.logger,i=o.getOuterProperty;if(typeof e=="string")return T(e,n,!0,r,s,i);if(Array.isArray(e))return e.map(u=>p(u,n,o)).join(o.indentStr?`
`:"");const t=J(e,s);if(!t)return"";const{tag:c,rest:a,children:l,attrs:f}=t;if(!B.has(c))return s.error(`Tag "${c}" is not allowed`),"";if(c==="$comment"&&o.insideComment)return s.error("Nested comments are not allowed"),"";if(c==="$if"){const{valueToRender:u}=H(a,n,r,s,i);return u===void 0?"":p(u,n,o)}A.has(c)&&l.length>0&&s.warn(`Tag "${c}" is a void element and cannot have children`);const d={...o,insideComment:c==="$comment"||o.insideComment,level:(o.level||0)+1},v=u=>u===""?[]:o.indentStr&&u.includes(`
`)&&!u.includes("<")?u.split(`
`).map(m=>[d.level,m]):[[d.level,u]];let $,h;if(K(a)){if(!w(a.$bind,"$bind",s))return"";const u=S(n,a.$bind,[],s,i),{$bind:m,$children:P=[],...W}=a;if(!Array.isArray(u)){if(u!=null&&typeof u!="object")return s.error(`$bind resolved to primitive value of type "${typeof u}", cannot render children`),"";const C=u&&typeof u=="object"&&u!==null?u:{},E=[...r,n];return p({[c]:{...W,$children:P}},C,{...o,parents:E})}if($=[],!A.has(c))for(const C of u){const E=[...r,n];for(const ne of P){const re=p(ne,C,{...d,parents:E});$.push(...v(re))}}h=W}else{if($=[],!A.has(c))for(const u of l){const m=p(u,n,{...d,parents:r});$.push(...v(m))}h=f}return X(c,h,n,$,s,o.indentStr,o.level,r,i)}function Z(e,n,o,r=[],s,i){const t=Object.entries(e).filter(([c])=>M(c,o,s)).map(([c,a])=>{let l;if(c==="style"){if(l=F(a,n,r,s,i),!l)return null}else if(Y(a)){const d=V(a,n,r,s,i);l=T(String(d),n,!1,r,s,i)}else l=T(String(a),n,!1,r,s,i);const f=z(c,l,s);return f==null?null:`${c}="${_(f)}"`}).filter(c=>c!==null).join(" ");return t?" "+t:""}function x(e,n={}){const{data:o={},yaml:r,indent:s,logger:i,useBlockContainer:t}=n,c=e.renderer.rules.fence;e.renderer.rules.fence=function(a,l,f,d,v){const $=a[l],h=$.info?$.info.trim():"";if(h==="treebark"||h.startsWith("treebark "))try{return ee($.content,o,r,s,i,t)+`
`}catch(u){const m=u instanceof Error?u.message:"Unknown error";return`<div class="treebark-error"><strong>Treebark Error:</strong> ${te(m)}</div>
`}return c?c(a,l,f,d,v):""}}function ee(e,n,o,r,s,i){let t,c=null;if(!e.trim())throw new Error("Empty or invalid template");if(o)try{t=o.load(e)}catch(l){c=l instanceof Error?l:new Error("YAML parsing failed")}if(!t)try{t=JSON.parse(e)}catch(l){throw o&&c?new Error(`Failed to parse as YAML or JSON. YAML error: ${c.message}`):new Error(`Failed to parse as JSON: ${l instanceof Error?l.message:"Invalid format"}`)}if(!t)throw new Error("Empty or invalid template");const a={indent:r,logger:s,useBlockContainer:i};if(t&&typeof t=="object"&&"template"in t){const l={...n,...t.data};return I({template:t.template,data:l},a)}else return I({template:t,data:n},a)}function te(e){const n={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,o=>n[o])}return x}));
//# sourceMappingURL=markdown-it-treebark-browser.min.js.map
