(function(y,m){typeof exports=="object"&&typeof module<"u"?module.exports=m():typeof define=="function"&&define.amd?define(m):(y=typeof globalThis<"u"?globalThis:y||self,y.MarkdownItTreebark=m())})(this,(function(){"use strict";const y=new Set(["div","span","p","header","footer","main","section","article","h1","h2","h3","h4","h5","h6","strong","em","blockquote","code","pre","ul","ol","li","table","thead","tbody","tr","th","td","a","button"]),m=new Set(["$comment","$if"]),b=new Set(["img","br","hr"]),W=new Set([...y,...m,...b]),E=new Set(["id","class","style","title","role","data-","aria-"]),_={a:new Set(["href","target","rel"]),img:new Set(["src","alt","width","height"]),table:new Set(["summary"]),th:new Set(["scope","colspan","rowspan"]),td:new Set(["scope","colspan","rowspan"]),blockquote:new Set(["cite"]),button:new Set(["type","disabled"])},C=new Set(["$<","$>","$<=","$>=","$=","$in"]),O=new Set(["$check","$then","$else","$not","$join",...C]),D=new Set(["behavior","-moz-binding"]);function A(e,n,o=[],r){if(n===".")return e;let i=e,s=n;for(;s.startsWith("..");){let t=0,a=s;for(;a.startsWith("..");)t++,a=a.substring(2),a.startsWith("/")&&(a=a.substring(1));if(t<=o.length)i=o[o.length-t],s=a.startsWith(".")?a.substring(1):a;else return}if(s){if(r&&typeof i!="object"&&i!==null&&i!==void 0){r.error(`Cannot access property "${s}" on primitive value of type "${typeof i}"`);return}return s.split(".").reduce((t,a)=>t&&typeof t=="object"&&t!==null?t[a]:void 0,i)}return i}function k(e){return e.replace(/[&<>"']/g,n=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[n]||n)}function w(e,n,o=!0,r=[],i){return e.replace(/\{\{\{([^{]*?)\}\}\}|\{\{([^{]*?)\}\}/g,(s,t,a)=>{if(t!==void 0)return`{{${t.trim()}}}`;const c=a.trim(),u=A(n,c,r,i);return u==null?"":o?k(String(u)):String(u)})}function R(e,n){const o=[];for(const[r,i]of Object.entries(e)){const s=r;if(!/^[a-z]([a-z0-9-]*[a-z0-9])?$/.test(s)){n.warn(`CSS property "${r}" has invalid format (must be kebab-case)`);continue}if(D.has(s)){n.warn(`CSS property "${r}" is blocked for security reasons`);continue}if(i==null)continue;let t=String(i).trim();if(t.includes(";")){const u=t;t=t.split(";")[0].trim(),t&&t!==u.trim()&&n.warn(`CSS value for "${r}" contained semicolon - using only first part: "${t}"`)}if(!t)continue;const a=/url\s*\(/i.test(t),c=/url\s*\(\s*['"]?data:/i.test(t);if(a&&!c||/expression\s*\(/i.test(t)||/javascript:/i.test(t)||/@import/i.test(t)){n.warn(`CSS value for "${r}" contains potentially dangerous pattern: "${t}"`);continue}o.push(`${s}: ${t}`)}return o.join("; ").trim()}function N(e,n,o,r){if(e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$check"in e&&typeof e.$check=="string"){const i=e;if(!v(i.$check,"$check",r))return"";const s=A(n,i.$check,o),a=g(s,i)?i.$then:i.$else;return a===void 0?"":typeof a=="object"&&a!==null&&!Array.isArray(a)?R(a,r):""}return typeof e=="object"&&e!==null&&!Array.isArray(e)?R(e,r):(r.error(`Style attribute must be an object with CSS properties, not ${typeof e}. Example: style: { "color": "red", "font-size": "14px" }`),"")}function G(e,n,o){const r=E.has(e)||[...E].some(t=>t.endsWith("-")&&e.startsWith(t)),i=_[n],s=i&&i.has(e);return!r&&!s?(o.warn(`Attribute "${e}" is not allowed on tag "${n}"`),!1):!0}function q(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$bind"in e}function v(e,n,o){return e==="."?!0:e.includes("..")?(o.error(`${n} does not support parent context access (..) - use interpolation {{..prop}} in content/attributes instead. Invalid: ${n}: "${e}"`),!1):e.includes("{{")?(o.error(`${n} does not support interpolation {{...}} - use literal property paths only. Invalid: ${n}: "${e}"`),!1):!0}function g(e,n){const o=[];for(const t of C)t in n&&o.push({key:t,value:n[t]});if(o.length===0){const t=!!e;return n.$not?!t:t}const r=o.map(t=>{switch(t.key){case"$<":return typeof e=="number"&&typeof t.value=="number"&&e<t.value;case"$>":return typeof e=="number"&&typeof t.value=="number"&&e>t.value;case"$<=":return typeof e=="number"&&typeof t.value=="number"&&e<=t.value;case"$>=":return typeof e=="number"&&typeof t.value=="number"&&e>=t.value;case"$=":return e===t.value;case"$in":return Array.isArray(t.value)&&t.value.includes(e);default:return!1}}),i=n.$join==="OR";let s;return i?s=r.some(t=>t):s=r.every(t=>t),n.$not?!s:s}function z(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$check"in e&&typeof e.$check=="string"}function B(e,n,o=[],r){if(!v(e.$check,"$check",r))return"";const i=A(n,e.$check,o);return g(i,e)?e.$then!==void 0?e.$then:"":e.$else!==void 0?e.$else:""}function M(e,n){if(!e||typeof e!="object"){n.error("Template object cannot be null, undefined, or non-object");return}const o=Object.entries(e);if(o.length===0){n.error("Template object must have at least one tag");return}const r=o[0];if(!r){n.error("Template object must have at least one tag");return}const[i,s]=r,t=typeof s=="string"?[s]:Array.isArray(s)?s:s?.$children||[],a=s&&typeof s=="object"&&!Array.isArray(s)?Object.fromEntries(Object.entries(s).filter(([c])=>c!=="$children")):{};return{tag:i,rest:s,children:t,attrs:a}}function F(e,n,o=[],r){const i=e;if(!i.$check)return r.error('"$if" tag requires $check attribute to specify the condition'),{valueToRender:void 0};if(!v(i.$check,"$check",r))return{valueToRender:void 0};const s=A(n,i.$check,o);typeof e=="object"&&e!==null&&!Array.isArray(e)&&"$children"in e&&r.warn('"$if" tag does not support $children, use $then and $else instead');const{$then:t,$else:a}=i;if(t!==void 0&&Array.isArray(t))return r.error('"$if" tag $then must be a string or single element object, not an array'),{valueToRender:void 0};if(a!==void 0&&Array.isArray(a))return r.error('"$if" tag $else must be a string or single element object, not an array'),{valueToRender:void 0};const u=(typeof e=="object"&&e!==null&&!Array.isArray(e)?Object.keys(e):[]).filter(d=>!O.has(d));return u.length>0&&r.warn(`"$if" tag does not support attributes: ${u.join(", ")}. Allowed: ${[...O].join(", ")}`),{valueToRender:g(s,i)?t:a}}const K=(e,n)=>{if(!n)return e.length<=1?e[0]?.[1]??"":e.reduce((r,[,i])=>r+i,"");if(e.length===0)return"";if(e.length===1&&!e[0][1].includes("<"))return e[0][1];let o=`
`;for(let r=0;r<e.length;r++)o+=n.repeat(e[r][0])+e[r][1],r<e.length-1&&(o+=`
`);return o+=`
`,o};function I(e,n={}){const o=e.data,r=n.logger||console,i=n.indent?{indentStr:typeof n.indent=="number"?" ".repeat(n.indent):typeof n.indent=="string"?n.indent:"  ",level:0,logger:r}:{logger:r};return $(e.template,o,i)}function Y(e,n,o,r,i,s,t,a=[]){const c=K(r,s),u=c.startsWith(`
`)&&s?s.repeat(t||0):"";if(e==="$comment")return`<!--${c}${u}-->`;const f=`<${e}${J(n,o,e,a,i)}>`;return b.has(e)?f:`${f}${c}${u}</${e}>`}function $(e,n,o){const r=o.parents||[],i=o.logger;if(typeof e=="string")return w(e,n,!0,r,i);if(Array.isArray(e))return e.map(l=>$(l,n,o)).join(o.indentStr?`
`:"");const s=M(e,i);if(!s)return"";const{tag:t,rest:a,children:c,attrs:u}=s;if(!W.has(t))return i.error(`Tag "${t}" is not allowed`),"";if(t==="$comment"&&o.insideComment)return i.error("Nested comments are not allowed"),"";if(t==="$if"){const{valueToRender:l}=F(a,n,r,i);return l===void 0?"":$(l,n,o)}b.has(t)&&c.length>0&&i.warn(`Tag "${t}" is a void element and cannot have children`);const f={...o,insideComment:t==="$comment"||o.insideComment,level:(o.level||0)+1},S=l=>l===""?[]:o.indentStr&&l.includes(`
`)&&!l.includes("<")?l.split(`
`).map(h=>[f.level,h]):[[f.level,l]];let d,p;if(q(a)){if(!v(a.$bind,"$bind",i))return"";const l=A(n,a.$bind,[],i),{$bind:h,$children:P=[],...L}=a;if(!Array.isArray(l)){if(l!=null&&typeof l!="object")return i.error(`$bind resolved to primitive value of type "${typeof l}", cannot render children`),"";const j=l&&typeof l=="object"&&l!==null?l:{},T=[...r,n];return $({[t]:{...L,$children:P}},j,{...o,parents:T})}if(d=[],!b.has(t))for(const j of l){const T=[...r,n];for(const Q of P){const X=$(Q,j,{...f,parents:T});d.push(...S(X))}}p=L}else{if(d=[],!b.has(t))for(const l of c){const h=$(l,n,{...f,parents:r});d.push(...S(h))}p=u}return Y(t,p,n,d,i,o.indentStr,o.level,r)}function J(e,n,o,r=[],i){const s=Object.entries(e).filter(([t])=>G(t,o,i)).map(([t,a])=>{let c;if(t==="style"){if(c=N(a,n,r,i),!c)return null}else if(z(a)){const u=B(a,n,r,i);c=w(String(u),n,!1,r,i)}else c=w(String(a),n,!1,r,i);return`${t}="${k(c)}"`}).filter(t=>t!==null).join(" ");return s?" "+s:""}function U(e,n={}){const{data:o={},yaml:r,indent:i,logger:s}=n,t=e.renderer.rules.fence;e.renderer.rules.fence=function(a,c,u,f,S){const d=a[c],p=d.info?d.info.trim():"";if(p==="treebark"||p.startsWith("treebark "))try{return H(d.content,o,r,i,s)+`
`}catch(l){const h=l instanceof Error?l.message:"Unknown error";return`<div class="treebark-error"><strong>Treebark Error:</strong> ${V(h)}</div>
`}return t?t(a,c,u,f,S):""}}function H(e,n,o,r,i){let s,t=null;if(!e.trim())throw new Error("Empty or invalid template");if(o)try{s=o.load(e)}catch(c){t=c instanceof Error?c:new Error("YAML parsing failed")}if(!s)try{s=JSON.parse(e)}catch(c){throw o&&t?new Error(`Failed to parse as YAML or JSON. YAML error: ${t.message}`):new Error(`Failed to parse as JSON: ${c instanceof Error?c.message:"Invalid format"}`)}if(!s)throw new Error("Empty or invalid template");const a={indent:r,logger:i};if(s&&typeof s=="object"&&"template"in s){const c={...n,...s.data};return I({template:s.template,data:c},a)}else return I({template:s,data:n},a)}function V(e){const n={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,o=>n[o])}return U}));
//# sourceMappingURL=markdown-it-treebark-browser.min.js.map
