(function(b,y){typeof exports=="object"&&typeof module<"u"?module.exports=y():typeof define=="function"&&define.amd?define(y):(b=typeof globalThis<"u"?globalThis:b||self,b.MarkdownItTreebark=y())})(this,(function(){"use strict";const b=new Set(["div","span","p","header","footer","main","section","article","h1","h2","h3","h4","h5","h6","strong","em","blockquote","code","pre","ul","ol","li","table","thead","tbody","tr","th","td","a"]),y=new Set(["$comment","$if"]),$=new Set(["img","br","hr"]),L=new Set([...b,...y,...$]),k=new Set(["id","class","style","title","role","data-","aria-"]),W={a:new Set(["href","target","rel"]),img:new Set(["src","alt","width","height"]),table:new Set(["summary"]),th:new Set(["scope","colspan","rowspan"]),td:new Set(["scope","colspan","rowspan"]),blockquote:new Set(["cite"])},E=new Set(["$<","$>","$<=","$>=","$=","$in"]),O=new Set(["$check","$then","$else","$not","$join",...E]),_=new Set(["display","position","top","right","bottom","left","z-index","float","clear","overflow","overflow-x","overflow-y","visibility","width","height","min-width","min-height","max-width","max-height","margin","margin-top","margin-right","margin-bottom","margin-left","padding","padding-top","padding-right","padding-bottom","padding-left","box-sizing","border","border-width","border-style","border-color","border-radius","border-top","border-right","border-bottom","border-left","border-top-width","border-right-width","border-bottom-width","border-left-width","border-top-style","border-right-style","border-bottom-style","border-left-style","border-top-color","border-right-color","border-bottom-color","border-left-color","border-top-left-radius","border-top-right-radius","border-bottom-left-radius","border-bottom-right-radius","outline","outline-width","outline-style","outline-color","outline-offset","background","background-color","background-position","background-size","background-repeat","background-attachment","background-clip","background-origin","color","font","font-family","font-size","font-weight","font-style","font-variant","line-height","letter-spacing","word-spacing","text-align","text-decoration","text-indent","text-transform","text-shadow","text-overflow","white-space","word-wrap","word-break","vertical-align","direction","unicode-bidi","list-style","list-style-type","list-style-position","border-collapse","border-spacing","caption-side","empty-cells","table-layout","flex","flex-direction","flex-wrap","flex-flow","justify-content","align-items","align-content","align-self","flex-grow","flex-shrink","flex-basis","order","gap","row-gap","column-gap","grid","grid-template","grid-template-columns","grid-template-rows","grid-template-areas","grid-column","grid-row","grid-area","grid-auto-columns","grid-auto-rows","grid-auto-flow","grid-column-start","grid-column-end","grid-row-start","grid-row-end","transform","transform-origin","transition","transition-property","transition-duration","transition-timing-function","transition-delay","animation","animation-name","animation-duration","animation-timing-function","animation-delay","animation-iteration-count","animation-direction","animation-fill-mode","animation-play-state","opacity","box-shadow","filter","backdrop-filter","cursor","pointer-events","resize","user-select","content","quotes","counter-reset","counter-increment","object-fit","object-position"]);function g(e,r,n=[],i){if(r===".")return e;let o=e,s=r;for(;s.startsWith("..");){let t=0,a=s;for(;a.startsWith("..");)t++,a=a.substring(2),a.startsWith("/")&&(a=a.substring(1));if(t<=n.length)o=n[n.length-t],s=a.startsWith(".")?a.substring(1):a;else return}if(s){if(i&&typeof o!="object"&&o!==null&&o!==void 0){i.error(`Cannot access property "${s}" on primitive value of type "${typeof o}"`);return}return s.split(".").reduce((t,a)=>t&&typeof t=="object"&&t!==null?t[a]:void 0,o)}return o}function C(e){return e.replace(/[&<>"']/g,r=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[r]||r)}function v(e,r,n=!0,i=[],o){return e.replace(/\{\{\{([^{]*?)\}\}\}|\{\{([^{]*?)\}\}/g,(s,t,a)=>{if(t!==void 0)return`{{${t.trim()}}}`;const l=a.trim(),d=g(r,l,i,o);return d==null?"":n?C(String(d)):String(d)})}function N(e,r){const n=[];for(const[i,o]of Object.entries(e)){const s=i;if(!_.has(s)){r.warn(`CSS property "${i}" is not in the allowed list`);continue}if(o==null)continue;const t=String(o).trim();if(/url\s*\(/i.test(t)||/expression\s*\(/i.test(t)||/javascript:/i.test(t)||/@import/i.test(t)){r.warn(`CSS value for "${i}" contains potentially dangerous pattern: "${t}"`);continue}n.push(`${s}: ${t}`)}return n.join("; ")}function D(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$check"in e&&typeof e.$check=="string"&&("$then"in e||"$else"in e)}function R(e,r,n,i){if(D(e)){const o=e;if(!A(o.$check,"$check",i))return"";const s=g(r,o.$check,n),a=S(s,o)?o.$then:o.$else;return a===void 0?"":R(a,r,n,i)}return typeof e=="object"&&e!==null&&!Array.isArray(e)?N(e,i):(i.error(`Style attribute must be an object with CSS properties, not ${typeof e}. Example: style: { "color": "red", "font-size": "14px" }`),"")}function G(e,r,n){const i=k.has(e)||[...k].some(t=>t.endsWith("-")&&e.startsWith(t)),o=W[r],s=o&&o.has(e);return!i&&!s?(n.warn(`Attribute "${e}" is not allowed on tag "${r}"`),!1):!0}function q(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$bind"in e}function A(e,r,n){return e==="."?!0:e.includes("..")?(n.error(`${r} does not support parent context access (..) - use interpolation {{..prop}} in content/attributes instead. Invalid: ${r}: "${e}"`),!1):e.includes("{{")?(n.error(`${r} does not support interpolation {{...}} - use literal property paths only. Invalid: ${r}: "${e}"`),!1):!0}function S(e,r){const n=[];for(const t of E)t in r&&n.push({key:t,value:r[t]});if(n.length===0){const t=!!e;return r.$not?!t:t}const i=n.map(t=>{switch(t.key){case"$<":return typeof e=="number"&&typeof t.value=="number"&&e<t.value;case"$>":return typeof e=="number"&&typeof t.value=="number"&&e>t.value;case"$<=":return typeof e=="number"&&typeof t.value=="number"&&e<=t.value;case"$>=":return typeof e=="number"&&typeof t.value=="number"&&e>=t.value;case"$=":return e===t.value;case"$in":return Array.isArray(t.value)&&t.value.includes(e);default:return!1}}),o=r.$join==="OR";let s;return o?s=i.some(t=>t):s=i.every(t=>t),r.$not?!s:s}function z(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$check"in e&&typeof e.$check=="string"}function M(e,r,n=[],i){if(!A(e.$check,"$check",i))return"";const o=g(r,e.$check,n);return S(o,e)?e.$then!==void 0?e.$then:"":e.$else!==void 0?e.$else:""}function B(e,r){if(!e||typeof e!="object"){r.error("Template object cannot be null, undefined, or non-object");return}const n=Object.entries(e);if(n.length===0){r.error("Template object must have at least one tag");return}const i=n[0];if(!i){r.error("Template object must have at least one tag");return}const[o,s]=i,t=typeof s=="string"?[s]:Array.isArray(s)?s:s?.$children||[],a=s&&typeof s=="object"&&!Array.isArray(s)?Object.fromEntries(Object.entries(s).filter(([l])=>l!=="$children")):{};return{tag:o,rest:s,children:t,attrs:a}}function F(e,r,n=[],i){const o=e;if(!o.$check)return i.error('"$if" tag requires $check attribute to specify the condition'),{valueToRender:void 0};if(!A(o.$check,"$check",i))return{valueToRender:void 0};const s=g(r,o.$check,n);typeof e=="object"&&e!==null&&!Array.isArray(e)&&"$children"in e&&i.warn('"$if" tag does not support $children, use $then and $else instead');const{$then:t,$else:a}=o;if(t!==void 0&&Array.isArray(t))return i.error('"$if" tag $then must be a string or single element object, not an array'),{valueToRender:void 0};if(a!==void 0&&Array.isArray(a))return i.error('"$if" tag $else must be a string or single element object, not an array'),{valueToRender:void 0};const d=(typeof e=="object"&&e!==null&&!Array.isArray(e)?Object.keys(e):[]).filter(u=>!O.has(u));return d.length>0&&i.warn(`"$if" tag does not support attributes: ${d.join(", ")}. Allowed: ${[...O].join(", ")}`),{valueToRender:S(s,o)?t:a}}const Y=(e,r)=>{if(!r)return e.length<=1?e[0]?.[1]??"":e.reduce((i,[,o])=>i+o,"");if(e.length===0)return"";if(e.length===1&&!e[0][1].includes("<"))return e[0][1];let n=`
`;for(let i=0;i<e.length;i++)n+=r.repeat(e[i][0])+e[i][1],i<e.length-1&&(n+=`
`);return n+=`
`,n};function x(e,r={}){const n=e.data,i=r.logger||console,o=r.indent?{indentStr:typeof r.indent=="number"?" ".repeat(r.indent):typeof r.indent=="string"?r.indent:"  ",level:0,logger:i}:{logger:i};return p(e.template,n,o)}function J(e,r,n,i,o,s,t,a=[]){const l=Y(i,s),d=l.startsWith(`
`)&&s?s.repeat(t||0):"";if(e==="$comment")return`<!--${l}${d}-->`;const f=`<${e}${K(r,n,e,a,o)}>`;return $.has(e)?f:`${f}${l}${d}</${e}>`}function p(e,r,n){const i=n.parents||[],o=n.logger;if(typeof e=="string")return v(e,r,!0,i,o);if(Array.isArray(e))return e.map(c=>p(c,r,n)).join(n.indentStr?`
`:"");const s=B(e,o);if(!s)return"";const{tag:t,rest:a,children:l,attrs:d}=s;if(!L.has(t))return o.error(`Tag "${t}" is not allowed`),"";if(t==="$comment"&&n.insideComment)return o.error("Nested comments are not allowed"),"";if(t==="$if"){const{valueToRender:c}=F(a,r,i,o);return c===void 0?"":p(c,r,n)}$.has(t)&&l.length>0&&o.warn(`Tag "${t}" is a void element and cannot have children`);const f={...n,insideComment:t==="$comment"||n.insideComment,level:(n.level||0)+1},w=c=>c===""?[]:n.indentStr&&c.includes(`
`)&&!c.includes("<")?c.split(`
`).map(m=>[f.level,m]):[[f.level,c]];let u,h;if(q(a)){if(!A(a.$bind,"$bind",o))return"";const c=g(r,a.$bind,[],o),{$bind:m,$children:I=[],...P}=a;if(!Array.isArray(c)){if(c!=null&&typeof c!="object")return o.error(`$bind resolved to primitive value of type "${typeof c}", cannot render children`),"";const j=c&&typeof c=="object"&&c!==null?c:{},T=[...i,r];return p({[t]:{...P,$children:I}},j,{...n,parents:T})}if(u=[],!$.has(t))for(const j of c){const T=[...i,r];for(const Q of I){const X=p(Q,j,{...f,parents:T});u.push(...w(X))}}h=P}else{if(u=[],!$.has(t))for(const c of l){const m=p(c,r,{...f,parents:i});u.push(...w(m))}h=d}return J(t,h,r,u,o,n.indentStr,n.level,i)}function K(e,r,n,i=[],o){const s=Object.entries(e).filter(([t])=>G(t,n,o)).map(([t,a])=>{let l;if(t==="style"){if(l=R(a,r,i,o),!l)return null}else if(z(a)){const d=M(a,r,i,o);l=v(String(d),r,!1,i,o)}else l=v(String(a),r,!1,i,o);return`${t}="${C(l)}"`}).filter(t=>t!==null).join(" ");return s?" "+s:""}function H(e,r={}){const{data:n={},yaml:i,indent:o,logger:s}=r,t=e.renderer.rules.fence;e.renderer.rules.fence=function(a,l,d,f,w){const u=a[l],h=u.info?u.info.trim():"";if(h==="treebark"||h.startsWith("treebark "))try{return U(u.content,n,i,o,s)+`
`}catch(c){const m=c instanceof Error?c.message:"Unknown error";return`<div class="treebark-error"><strong>Treebark Error:</strong> ${V(m)}</div>
`}return t?t(a,l,d,f,w):""}}function U(e,r,n,i,o){let s,t=null;if(!e.trim())throw new Error("Empty or invalid template");if(n)try{s=n.load(e)}catch(l){t=l instanceof Error?l:new Error("YAML parsing failed")}if(!s)try{s=JSON.parse(e)}catch(l){throw n&&t?new Error(`Failed to parse as YAML or JSON. YAML error: ${t.message}`):new Error(`Failed to parse as JSON: ${l instanceof Error?l.message:"Invalid format"}`)}if(!s)throw new Error("Empty or invalid template");const a={indent:i,logger:o};if(s&&typeof s=="object"&&"template"in s){const l={...r,...s.data};return x({template:s.template,data:l},a)}else return x({template:s,data:r},a)}function V(e){const r={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,n=>r[n])}return H}));
//# sourceMappingURL=markdown-it-treebark-browser.min.js.map
