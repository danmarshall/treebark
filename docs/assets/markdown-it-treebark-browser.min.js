(function(y,g){typeof exports=="object"&&typeof module<"u"?module.exports=g():typeof define=="function"&&define.amd?define(g):(y=typeof globalThis<"u"?globalThis:y||self,y.MarkdownItTreebark=g())})(this,(function(){"use strict";const y={error:e=>console.error(e)};function g(e){return e||y}function u(e,n){g(e).error(n)}const W=new Set(["div","span","p","header","footer","main","section","article","h1","h2","h3","h4","h5","h6","strong","em","blockquote","code","pre","ul","ol","li","table","thead","tbody","tr","th","td","a"]),N=new Set(["$comment","$if"]),A=new Set(["img","br","hr"]),G=new Set([...W,...N,...A]),O=new Set(["id","class","style","title","role","data-","aria-"]),_={a:new Set(["href","target","rel"]),img:new Set(["src","alt","width","height"]),table:new Set(["summary"]),th:new Set(["scope","colspan","rowspan"]),td:new Set(["scope","colspan","rowspan"]),blockquote:new Set(["cite"])},C=new Set(["$<","$>","$<=","$>=","$=","$in"]),R=new Set(["$check","$then","$else","$not","$join",...C]);function b(e,n,r=[]){if(n===".")return e;let o=e,i=n;for(;i.startsWith("..");){let s=0,t=i;for(;t.startsWith("..");)s++,t=t.substring(2),t.startsWith("/")&&(t=t.substring(1));if(s<=r.length)o=r[r.length-s],i=t.startsWith(".")?t.substring(1):t;else return}return i?i.split(".").reduce((s,t)=>s&&typeof s=="object"&&s!==null?s[t]:void 0,o):o}function w(e){return e.replace(/[&<>"']/g,n=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[n]||n)}function T(e,n,r=!0,o=[]){return e.replace(/\{\{\{([^{]*?)\}\}\}|\{\{([^{]*?)\}\}/g,(i,s,t)=>{if(s!==void 0)return`{{${s.trim()}}}`;const a=t.trim(),l=b(n,a,o);return l==null?"":r?w(String(l)):String(l)})}function q(e,n,r){const o=O.has(e)||[...O].some(t=>t.endsWith("-")&&e.startsWith(t)),i=_[n],s=i&&i.has(e);return!o&&!s?(u(r,`Attribute "${e}" is not allowed on tag "${n}"`),!1):!0}function M(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$bind"in e}function S(e,n,r){return e==="."?!0:e.includes("..")?(u(r,`${n} does not support parent context access (..) - use interpolation {{..prop}} in content/attributes instead. Invalid: ${n}: "${e}"`),!1):e.includes("{{")?(u(r,`${n} does not support interpolation {{...}} - use literal property paths only. Invalid: ${n}: "${e}"`),!1):!0}function k(e,n){const r=[];for(const t of C)t in n&&r.push({key:t,value:n[t]});if(r.length===0){const t=!!e;return n.$not?!t:t}const o=r.map(t=>{switch(t.key){case"$<":return typeof e=="number"&&typeof t.value=="number"&&e<t.value;case"$>":return typeof e=="number"&&typeof t.value=="number"&&e>t.value;case"$<=":return typeof e=="number"&&typeof t.value=="number"&&e<=t.value;case"$>=":return typeof e=="number"&&typeof t.value=="number"&&e>=t.value;case"$=":return e===t.value;case"$in":return Array.isArray(t.value)&&t.value.includes(e);default:return!1}}),i=n.$join==="OR";let s;return i?s=o.some(t=>t):s=o.every(t=>t),n.$not?!s:s}function B(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$check"in e&&typeof e.$check=="string"}function D(e,n,r=[],o){if(!S(e.$check,"$check",o))return"";const i=b(n,e.$check,r);return k(i,e)?e.$then!==void 0?e.$then:"":e.$else!==void 0?e.$else:""}function F(e,n){if(!e||typeof e!="object"){u(n,"Template object cannot be null, undefined, or non-object");return}const r=Object.entries(e);if(r.length===0){u(n,"Template object must have at least one tag");return}const o=r[0];if(!o){u(n,"Template object must have at least one tag");return}const[i,s]=o,t=typeof s=="string"?[s]:Array.isArray(s)?s:s?.$children||[],a=s&&typeof s=="object"&&!Array.isArray(s)?Object.fromEntries(Object.entries(s).filter(([l])=>l!=="$children")):{};return{tag:i,rest:s,children:t,attrs:a}}function Y(e,n,r=[],o){const i=e;if(!i.$check)return u(o,'"$if" tag requires $check attribute to specify the condition'),{valueToRender:void 0};if(!S(i.$check,"$check",o))return{valueToRender:void 0};const s=b(n,i.$check,r);if(typeof e=="object"&&e!==null&&!Array.isArray(e)&&"$children"in e)return u(o,'"$if" tag does not support $children, use $then and $else instead'),{valueToRender:void 0};const{$then:t,$else:a}=i;if(t!==void 0&&Array.isArray(t))return u(o,'"$if" tag $then must be a string or single element object, not an array'),{valueToRender:void 0};if(a!==void 0&&Array.isArray(a))return u(o,'"$if" tag $else must be a string or single element object, not an array'),{valueToRender:void 0};const f=(typeof e=="object"&&e!==null&&!Array.isArray(e)?Object.keys(e):[]).filter($=>!R.has($));return f.length>0?(u(o,`"$if" tag does not support attributes: ${f.join(", ")}. Allowed: ${[...R].join(", ")}`),{valueToRender:void 0}):{valueToRender:k(s,i)?t:a}}const J=(e,n)=>{if(!n)return e.length<=1?e[0]?.[1]??"":e.reduce((o,[,i])=>o+i,"");if(e.length===0)return"";if(e.length===1&&!e[0][1].includes("<"))return e[0][1];let r=`
`;for(let o=0;o<e.length;o++)r+=n.repeat(e[o][0])+e[o][1],o<e.length-1&&(r+=`
`);return r+=`
`,r};function I(e,n={}){const r=Array.isArray(e.data)?e.data:{...e.data,...n.data},o=n.indent?{indentStr:typeof n.indent=="number"?" ".repeat(n.indent):typeof n.indent=="string"?n.indent:"  ",level:0,logger:n.logger}:{logger:n.logger};return m(e.template,r,o)}function K(e,n,r,o,i,s,t=[],a){const l=J(o,i),f=l.startsWith(`
`)&&i?i.repeat(s||0):"";if(e==="$comment")return`<!--${l}${f}-->`;const d=`<${e}${H(n,r,e,t,a)}>`;return A.has(e)?d:`${d}${l}${f}</${e}>`}function m(e,n,r={}){const o=r.parents||[],i=r.logger;if(typeof e=="string")return T(e,n,!0,o);if(Array.isArray(e))return e.map(c=>m(c,n,r)).join(r.indentStr?`
`:"");const s=F(e,i);if(!s)return"";const{tag:t,rest:a,children:l,attrs:f}=s;if(!G.has(t))return u(i,`Tag "${t}" is not allowed`),"";if(t==="$comment"&&r.insideComment)return u(i,"Nested comments are not allowed"),"";if(t==="$if"){const{valueToRender:c}=Y(a,n,o,i);return c===void 0?"":m(c,n,r)}if(A.has(t)&&l.length>0)return u(i,`Tag "${t}" is a void element and cannot have children`),"";const d={...r,insideComment:t==="$comment"||r.insideComment,level:(r.level||0)+1},h=c=>c===""?[]:r.indentStr&&c.includes(`
`)&&!c.includes("<")?c.split(`
`).map(v=>[d.level,v]):[[d.level,c]];let $,p;if(M(a)){if(!S(a.$bind,"$bind",i))return"";const c=b(n,a.$bind,[]),{$bind:v,$children:L=[],...P}=a;if(!Array.isArray(c)){const j=c&&typeof c=="object"&&c!==null?c:{},E=[...o,n];return m({[t]:{...P,$children:L}},j,{...r,parents:E})}$=[];for(const j of c){const E=[...o,n];for(const X of L){const Z=m(X,j,{...d,parents:E});$.push(...h(Z))}}p=P}else{$=[];for(const c of l){const v=m(c,n,{...d,parents:o});$.push(...h(v))}p=f}return K(t,p,n,$,r.indentStr,r.level,o,i)}function H(e,n,r,o=[],i){const s=Object.entries(e).filter(([t])=>q(t,r,i)).map(([t,a])=>{if(B(a)){const l=D(a,n,o,i);return`${t}="${w(T(String(l),n,!1,o))}"`}else return`${t}="${w(T(String(a),n,!1,o))}"`}).join(" ");return s?" "+s:""}function U(e,n={}){const{data:r={},yaml:o,indent:i}=n,s=e.renderer.rules.fence;e.renderer.rules.fence=function(t,a,l,f,d){const h=t[a],$=h.info?h.info.trim():"";if($==="treebark"||$.startsWith("treebark "))try{return z(h.content,r,o,i)+`
`}catch(p){const c=p instanceof Error?p.message:"Unknown error";return`<div class="treebark-error"><strong>Treebark Error:</strong> ${Q(c)}</div>
`}return s?s(t,a,l,f,d):""}}function z(e,n,r,o){let i,s=null;if(!e.trim())throw new Error("Empty or invalid template");if(r)try{i=r.load(e)}catch(t){s=t instanceof Error?t:new Error("YAML parsing failed")}if(!i)try{i=JSON.parse(e)}catch(t){throw r&&s?new Error(`Failed to parse as YAML or JSON. YAML error: ${s.message}`):new Error(`Failed to parse as JSON: ${t instanceof Error?t.message:"Invalid format"}`)}if(!i)throw new Error("Empty or invalid template");if(i&&typeof i=="object"&&"template"in i){const t={...n,...i.data};return I({template:i.template,data:t},{indent:o})}return I({template:i,data:n},{indent:o})}function Q(e){const n={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,r=>n[r])}return U}));
//# sourceMappingURL=markdown-it-treebark-browser.min.js.map
