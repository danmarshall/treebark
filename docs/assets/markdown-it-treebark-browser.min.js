(function(y,m){typeof exports=="object"&&typeof module<"u"?module.exports=m():typeof define=="function"&&define.amd?define(m):(y=typeof globalThis<"u"?globalThis:y||self,y.MarkdownItTreebark=m())})(this,(function(){"use strict";const y=new Set(["div","span","p","header","footer","main","section","article","h1","h2","h3","h4","h5","h6","strong","em","blockquote","code","pre","ul","ol","li","table","thead","tbody","tr","th","td","a"]),m=new Set(["$comment","$if"]),b=new Set(["img","br","hr"]),W=new Set([...y,...m,...b]),E=new Set(["id","class","style","title","role","data-","aria-"]),_={a:new Set(["href","target","rel"]),img:new Set(["src","alt","width","height"]),table:new Set(["summary"]),th:new Set(["scope","colspan","rowspan"]),td:new Set(["scope","colspan","rowspan"]),blockquote:new Set(["cite"])},C=new Set(["$<","$>","$<=","$>=","$=","$in"]),O=new Set(["$check","$then","$else","$not","$join",...C]),D=new Set(["behavior","-moz-binding"]);function A(e,n,r=[],i){if(n===".")return e;let o=e,s=n;for(;s.startsWith("..");){let t=0,c=s;for(;c.startsWith("..");)t++,c=c.substring(2),c.startsWith("/")&&(c=c.substring(1));if(t<=r.length)o=r[r.length-t],s=c.startsWith(".")?c.substring(1):c;else return}if(s){if(i&&typeof o!="object"&&o!==null&&o!==void 0){i.error(`Cannot access property "${s}" on primitive value of type "${typeof o}"`);return}return s.split(".").reduce((t,c)=>t&&typeof t=="object"&&t!==null?t[c]:void 0,o)}return o}function k(e){return e.replace(/[&<>"']/g,n=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[n]||n)}function w(e,n,r=!0,i=[],o){return e.replace(/\{\{\{([^{]*?)\}\}\}|\{\{([^{]*?)\}\}/g,(s,t,c)=>{if(t!==void 0)return`{{${t.trim()}}}`;const a=c.trim(),u=A(n,a,i,o);return u==null?"":r?k(String(u)):String(u)})}function N(e,n){const r=[];for(const[i,o]of Object.entries(e)){const s=i;if(!/^[a-z]([a-z0-9-]*[a-z0-9])?$/.test(s)){n.warn(`CSS property "${i}" has invalid format (must be kebab-case)`);continue}if(D.has(s)){n.warn(`CSS property "${i}" is blocked for security reasons`);continue}if(o==null)continue;const t=String(o).trim(),c=/url\s*\(/i.test(t),a=/url\s*\(\s*['"]?data:/i.test(t);if(c&&!a||/expression\s*\(/i.test(t)||/javascript:/i.test(t)||/@import/i.test(t)||/;/.test(t)){n.warn(`CSS value for "${i}" contains potentially dangerous pattern: "${t}"`);continue}r.push(`${s}: ${t}`)}return r.join("; ")}function G(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$check"in e&&typeof e.$check=="string"&&("$then"in e||"$else"in e)}function R(e,n,r,i){if(G(e)){const o=e;if(!v(o.$check,"$check",i))return"";const s=A(n,o.$check,r),c=g(s,o)?o.$then:o.$else;return c===void 0?"":R(c,n,r,i)}return typeof e=="object"&&e!==null&&!Array.isArray(e)?N(e,i):(i.error(`Style attribute must be an object with CSS properties, not ${typeof e}. Example: style: { "color": "red", "font-size": "14px" }`),"")}function q(e,n,r){const i=E.has(e)||[...E].some(t=>t.endsWith("-")&&e.startsWith(t)),o=_[n],s=o&&o.has(e);return!i&&!s?(r.warn(`Attribute "${e}" is not allowed on tag "${n}"`),!1):!0}function z(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$bind"in e}function v(e,n,r){return e==="."?!0:e.includes("..")?(r.error(`${n} does not support parent context access (..) - use interpolation {{..prop}} in content/attributes instead. Invalid: ${n}: "${e}"`),!1):e.includes("{{")?(r.error(`${n} does not support interpolation {{...}} - use literal property paths only. Invalid: ${n}: "${e}"`),!1):!0}function g(e,n){const r=[];for(const t of C)t in n&&r.push({key:t,value:n[t]});if(r.length===0){const t=!!e;return n.$not?!t:t}const i=r.map(t=>{switch(t.key){case"$<":return typeof e=="number"&&typeof t.value=="number"&&e<t.value;case"$>":return typeof e=="number"&&typeof t.value=="number"&&e>t.value;case"$<=":return typeof e=="number"&&typeof t.value=="number"&&e<=t.value;case"$>=":return typeof e=="number"&&typeof t.value=="number"&&e>=t.value;case"$=":return e===t.value;case"$in":return Array.isArray(t.value)&&t.value.includes(e);default:return!1}}),o=n.$join==="OR";let s;return o?s=i.some(t=>t):s=i.every(t=>t),n.$not?!s:s}function B(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$check"in e&&typeof e.$check=="string"}function M(e,n,r=[],i){if(!v(e.$check,"$check",i))return"";const o=A(n,e.$check,r);return g(o,e)?e.$then!==void 0?e.$then:"":e.$else!==void 0?e.$else:""}function F(e,n){if(!e||typeof e!="object"){n.error("Template object cannot be null, undefined, or non-object");return}const r=Object.entries(e);if(r.length===0){n.error("Template object must have at least one tag");return}const i=r[0];if(!i){n.error("Template object must have at least one tag");return}const[o,s]=i,t=typeof s=="string"?[s]:Array.isArray(s)?s:s?.$children||[],c=s&&typeof s=="object"&&!Array.isArray(s)?Object.fromEntries(Object.entries(s).filter(([a])=>a!=="$children")):{};return{tag:o,rest:s,children:t,attrs:c}}function K(e,n,r=[],i){const o=e;if(!o.$check)return i.error('"$if" tag requires $check attribute to specify the condition'),{valueToRender:void 0};if(!v(o.$check,"$check",i))return{valueToRender:void 0};const s=A(n,o.$check,r);typeof e=="object"&&e!==null&&!Array.isArray(e)&&"$children"in e&&i.warn('"$if" tag does not support $children, use $then and $else instead');const{$then:t,$else:c}=o;if(t!==void 0&&Array.isArray(t))return i.error('"$if" tag $then must be a string or single element object, not an array'),{valueToRender:void 0};if(c!==void 0&&Array.isArray(c))return i.error('"$if" tag $else must be a string or single element object, not an array'),{valueToRender:void 0};const u=(typeof e=="object"&&e!==null&&!Array.isArray(e)?Object.keys(e):[]).filter(d=>!O.has(d));return u.length>0&&i.warn(`"$if" tag does not support attributes: ${u.join(", ")}. Allowed: ${[...O].join(", ")}`),{valueToRender:g(s,o)?t:c}}const Y=(e,n)=>{if(!n)return e.length<=1?e[0]?.[1]??"":e.reduce((i,[,o])=>i+o,"");if(e.length===0)return"";if(e.length===1&&!e[0][1].includes("<"))return e[0][1];let r=`
`;for(let i=0;i<e.length;i++)r+=n.repeat(e[i][0])+e[i][1],i<e.length-1&&(r+=`
`);return r+=`
`,r};function I(e,n={}){const r=e.data,i=n.logger||console,o=n.indent?{indentStr:typeof n.indent=="number"?" ".repeat(n.indent):typeof n.indent=="string"?n.indent:"  ",level:0,logger:i}:{logger:i};return $(e.template,r,o)}function J(e,n,r,i,o,s,t,c=[]){const a=Y(i,s),u=a.startsWith(`
`)&&s?s.repeat(t||0):"";if(e==="$comment")return`<!--${a}${u}-->`;const f=`<${e}${U(n,r,e,c,o)}>`;return b.has(e)?f:`${f}${a}${u}</${e}>`}function $(e,n,r){const i=r.parents||[],o=r.logger;if(typeof e=="string")return w(e,n,!0,i,o);if(Array.isArray(e))return e.map(l=>$(l,n,r)).join(r.indentStr?`
`:"");const s=F(e,o);if(!s)return"";const{tag:t,rest:c,children:a,attrs:u}=s;if(!W.has(t))return o.error(`Tag "${t}" is not allowed`),"";if(t==="$comment"&&r.insideComment)return o.error("Nested comments are not allowed"),"";if(t==="$if"){const{valueToRender:l}=K(c,n,i,o);return l===void 0?"":$(l,n,r)}b.has(t)&&a.length>0&&o.warn(`Tag "${t}" is a void element and cannot have children`);const f={...r,insideComment:t==="$comment"||r.insideComment,level:(r.level||0)+1},S=l=>l===""?[]:r.indentStr&&l.includes(`
`)&&!l.includes("<")?l.split(`
`).map(p=>[f.level,p]):[[f.level,l]];let d,h;if(z(c)){if(!v(c.$bind,"$bind",o))return"";const l=A(n,c.$bind,[],o),{$bind:p,$children:P=[],...L}=c;if(!Array.isArray(l)){if(l!=null&&typeof l!="object")return o.error(`$bind resolved to primitive value of type "${typeof l}", cannot render children`),"";const j=l&&typeof l=="object"&&l!==null?l:{},T=[...i,n];return $({[t]:{...L,$children:P}},j,{...r,parents:T})}if(d=[],!b.has(t))for(const j of l){const T=[...i,n];for(const X of P){const Z=$(X,j,{...f,parents:T});d.push(...S(Z))}}h=L}else{if(d=[],!b.has(t))for(const l of a){const p=$(l,n,{...f,parents:i});d.push(...S(p))}h=u}return J(t,h,n,d,o,r.indentStr,r.level,i)}function U(e,n,r,i=[],o){const s=Object.entries(e).filter(([t])=>q(t,r,o)).map(([t,c])=>{let a;if(t==="style"){if(a=R(c,n,i,o),!a)return null}else if(B(c)){const u=M(c,n,i,o);a=w(String(u),n,!1,i,o)}else a=w(String(c),n,!1,i,o);return`${t}="${k(a)}"`}).filter(t=>t!==null).join(" ");return s?" "+s:""}function H(e,n={}){const{data:r={},yaml:i,indent:o,logger:s}=n,t=e.renderer.rules.fence;e.renderer.rules.fence=function(c,a,u,f,S){const d=c[a],h=d.info?d.info.trim():"";if(h==="treebark"||h.startsWith("treebark "))try{return V(d.content,r,i,o,s)+`
`}catch(l){const p=l instanceof Error?l.message:"Unknown error";return`<div class="treebark-error"><strong>Treebark Error:</strong> ${Q(p)}</div>
`}return t?t(c,a,u,f,S):""}}function V(e,n,r,i,o){let s,t=null;if(!e.trim())throw new Error("Empty or invalid template");if(r)try{s=r.load(e)}catch(a){t=a instanceof Error?a:new Error("YAML parsing failed")}if(!s)try{s=JSON.parse(e)}catch(a){throw r&&t?new Error(`Failed to parse as YAML or JSON. YAML error: ${t.message}`):new Error(`Failed to parse as JSON: ${a instanceof Error?a.message:"Invalid format"}`)}if(!s)throw new Error("Empty or invalid template");const c={indent:i,logger:o};if(s&&typeof s=="object"&&"template"in s){const a={...n,...s.data};return I({template:s.template,data:a},c)}else return I({template:s,data:n},c)}function Q(e){const n={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,r=>n[r])}return H}));
//# sourceMappingURL=markdown-it-treebark-browser.min.js.map
