(function(b,A){typeof exports=="object"&&typeof module<"u"?module.exports=A():typeof define=="function"&&define.amd?define(A):(b=typeof globalThis<"u"?globalThis:b||self,b.MarkdownItTreebark=A())})(this,(function(){"use strict";const b=new Set(["div","span","p","header","footer","main","section","article","h1","h2","h3","h4","h5","h6","strong","em","blockquote","code","pre","ul","ol","li","table","thead","tbody","tr","th","td","a"]),A=new Set(["$comment","$if"]),S=new Set(["img","br","hr"]),N=new Set([...b,...A,...S]),O=new Set(["id","class","style","title","role","data-","aria-"]),F={a:new Set(["href","target","rel"]),img:new Set(["src","alt","width","height"]),table:new Set(["summary"]),th:new Set(["scope","colspan","rowspan"]),td:new Set(["scope","colspan","rowspan"]),blockquote:new Set(["cite"])},k=new Set(["$<","$>","$<=","$>=","$=","$in"]),R=new Set(["$check","$then","$else","$not","$join",...k]);[...k];const G=new Set(["behavior","-moz-binding"]);function p(e,t,o=[],i,c){if(t===".")return e;let n=e,r=t;for(;r.startsWith("..");){let a=0,s=r;for(;s.startsWith("..");)a++,s=s.substring(2),s.startsWith("/")&&(s=s.substring(1));if(a<=o.length)n=o[o.length-a],r=s.startsWith(".")?s.substring(1):s;else return c?c(t,e,o):void 0}if(r){if(i&&typeof n!="object"&&n!==null&&n!==void 0){i.error(`Cannot access property "${r}" on primitive value of type "${typeof n}"`);return}const a=r.split(".").reduce((s,f)=>s&&typeof s=="object"&&s!==null?s[f]:void 0,n);return a===void 0&&c?c(t,e,o):a}return n}function I(e){return e.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t]||t)}function C(e,t,o=!0,i=[],c,n){return e.replace(/\{\{\{([^{]*?)\}\}\}|\{\{([^{]*?)\}\}/g,(r,a,s)=>{if(a!==void 0)return`{{${a.trim()}}}`;const f=s.trim(),u=p(t,f,i,c,n);return u==null?"":o?I(String(u)):String(u)})}function L(e,t){const o=[];for(const[i,c]of Object.entries(e)){const n=i;if(!/^[a-z]([a-z0-9-]*[a-z0-9])?$/.test(n)){t.warn(`CSS property "${i}" has invalid format (must be kebab-case)`);continue}if(G.has(n)){t.warn(`CSS property "${i}" is blocked for security reasons`);continue}if(c==null)continue;let r=String(c).trim();if(r.includes(";")){const f=r;r=r.split(";")[0].trim(),r&&r!==f.trim()&&t.warn(`CSS value for "${i}" contained semicolon - using only first part: "${r}"`)}if(!r)continue;const a=/url\s*\(/i.test(r),s=/url\s*\(\s*['"]?data:/i.test(r);if(a&&!s||/expression\s*\(/i.test(r)||/javascript:/i.test(r)||/@import/i.test(r)){t.warn(`CSS value for "${i}" contains potentially dangerous pattern: "${r}"`);continue}o.push(`${n}: ${r}`)}return o.join("; ").trim()}function q(e,t,o,i,c){if(e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$check"in e&&typeof e.$check=="string"){const n=e;if(!w(n.$check,"$check",i))return"";const r=p(t,n.$check,o,i,c),s=T(r,n)?n.$then:n.$else;return s===void 0?"":typeof s=="object"&&s!==null&&!Array.isArray(s)?L(s,i):""}return typeof e=="object"&&e!==null&&!Array.isArray(e)?L(e,i):(i.error(`Style attribute must be an object with CSS properties, not ${typeof e}. Example: style: { "color": "red", "font-size": "14px" }`),"")}function z(e,t,o){const i=O.has(e)||[...O].some(r=>r.endsWith("-")&&e.startsWith(r)),c=F[t],n=c&&c.has(e);return!i&&!n?(o.warn(`Attribute "${e}" is not allowed on tag "${t}"`),!1):!0}function B(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$bind"in e}function w(e,t,o){return e==="."?!0:e.includes("..")?(o.error(`${t} does not support parent context access (..) - use interpolation {{..prop}} in content/attributes instead. Invalid: ${t}: "${e}"`),!1):e.includes("{{")?(o.error(`${t} does not support interpolation {{...}} - use literal property paths only. Invalid: ${t}: "${e}"`),!1):!0}function T(e,t){const o=[];for(const r of k)r in t&&o.push({key:r,value:t[r]});if(o.length===0){const r=!!e;return t.$not?!r:r}const i=o.map(r=>{switch(r.key){case"$<":return typeof e=="number"&&typeof r.value=="number"&&e<r.value;case"$>":return typeof e=="number"&&typeof r.value=="number"&&e>r.value;case"$<=":return typeof e=="number"&&typeof r.value=="number"&&e<=r.value;case"$>=":return typeof e=="number"&&typeof r.value=="number"&&e>=r.value;case"$=":return e===r.value;case"$in":return Array.isArray(r.value)&&r.value.includes(e);default:return!1}}),c=t.$join==="OR";let n;return c?n=i.some(r=>r):n=i.every(r=>r),t.$not?!n:n}function M(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$check"in e&&typeof e.$check=="string"}function K(e,t,o=[],i,c){if(!w(e.$check,"$check",i))return"";const n=p(t,e.$check,o,i,c);return T(n,e)?e.$then!==void 0?e.$then:"":e.$else!==void 0?e.$else:""}function Y(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$check"in e&&typeof e.$check=="string"}function J(e,t,o=[],i,c){if(!w(t.$check,"$check",i))return!1;const n=p(e,t.$check,o,i,c);return T(n,t)}function U(e,t){if(!e||typeof e!="object"){t.error("Template object cannot be null, undefined, or non-object");return}const o=Object.entries(e);if(o.length===0){t.error("Template object must have at least one tag");return}const i=o[0];if(!i){t.error("Template object must have at least one tag");return}const[c,n]=i,r=typeof n=="string"?[n]:Array.isArray(n)?n:n?.$children||[],a=n&&typeof n=="object"&&!Array.isArray(n)?Object.fromEntries(Object.entries(n).filter(([s])=>s!=="$children")):{};return{tag:c,rest:n,children:r,attrs:a}}function V(e,t,o=[],i,c){const n=e;if(!n.$check)return i.error('"$if" tag requires $check attribute to specify the condition'),{valueToRender:void 0};if(!w(n.$check,"$check",i))return{valueToRender:void 0};const r=p(t,n.$check,o,i,c);typeof e=="object"&&e!==null&&!Array.isArray(e)&&"$children"in e&&i.warn('"$if" tag does not support $children, use $then and $else instead');const{$then:a,$else:s}=n;if(a!==void 0&&Array.isArray(a))return i.error('"$if" tag $then must be a string or single element object, not an array'),{valueToRender:void 0};if(s!==void 0&&Array.isArray(s))return i.error('"$if" tag $else must be a string or single element object, not an array'),{valueToRender:void 0};const u=(typeof e=="object"&&e!==null&&!Array.isArray(e)?Object.keys(e):[]).filter($=>!R.has($));return u.length>0&&i.warn(`"$if" tag does not support attributes: ${u.join(", ")}. Allowed: ${[...R].join(", ")}`),{valueToRender:T(r,n)?a:s}}const H=(e,t)=>{if(!t)return e.length<=1?e[0]?.[1]??"":e.reduce((i,[,c])=>i+c,"");if(e.length===0)return"";if(e.length===1&&!e[0][1].includes("<"))return e[0][1];let o=`
`;for(let i=0;i<e.length;i++)o+=t.repeat(e[i][0])+e[i][1],i<e.length-1&&(o+=`
`);return o+=`
`,o};function P(e,t={}){const o=e.data,i=t.logger||console,c=t.propertyFallback,n=t.indent?{indentStr:typeof t.indent=="number"?" ".repeat(t.indent):typeof t.indent=="string"?t.indent:"  ",level:0,logger:i,getOuterProperty:c}:{logger:i,getOuterProperty:c};return y(e.template,o,n)}function Q(e,t,o,i,c,n,r,a=[],s){const f=H(i,n),u=f.startsWith(`
`)&&n?n.repeat(r||0):"";if(e==="$comment")return`<!--${f}${u}-->`;const d=`<${e}${X(t,o,e,a,c,s)}>`;return S.has(e)?d:`${d}${f}${u}</${e}>`}function y(e,t,o){const i=o.parents||[],c=o.logger,n=o.getOuterProperty;if(typeof e=="string")return C(e,t,!0,i,c,n);if(Array.isArray(e))return e.map(l=>y(l,t,o)).join(o.indentStr?`
`:"");const r=U(e,c);if(!r)return"";const{tag:a,rest:s,children:f,attrs:u}=r;if(!N.has(a))return c.error(`Tag "${a}" is not allowed`),"";if(a==="$comment"&&o.insideComment)return c.error("Nested comments are not allowed"),"";if(a==="$if"){const{valueToRender:l}=V(s,t,i,c,n);return l===void 0?"":y(l,t,o)}S.has(a)&&f.length>0&&c.warn(`Tag "${a}" is a void element and cannot have children`);const d={...o,insideComment:a==="$comment"||o.insideComment,level:(o.level||0)+1},h=l=>l===""?[]:o.indentStr&&l.includes(`
`)&&!l.includes("<")?l.split(`
`).map(g=>[d.level,g]):[[d.level,l]];let $,m;if(B(s)){if(!w(s.$bind,"$bind",c))return"";const l=p(t,s.$bind,[],c,n),{$bind:g,$filter:E,$children:W=[],..._}=s;if(!Array.isArray(l)){if(l!=null&&typeof l!="object")return c.error(`$bind resolved to primitive value of type "${typeof l}", cannot render children`),"";const v=l&&typeof l=="object"&&l!==null?l:{},j=[...i,t];return y({[a]:{..._,$children:W}},v,{...o,parents:j})}let D=l;if(E&&Y(E)&&(D=l.filter(v=>{const j=[...i,t];return J(v,E,j,c,n)})),$=[],!S.has(a))for(const v of D){const j=[...i,t];for(const te of W){const ne=y(te,v,{...d,parents:j});$.push(...h(ne))}}m=_}else{if($=[],!S.has(a))for(const l of f){const g=y(l,t,{...d,parents:i});$.push(...h(g))}m=u}return Q(a,m,t,$,c,o.indentStr,o.level,i,n)}function X(e,t,o,i=[],c,n){const r=Object.entries(e).filter(([a])=>z(a,o,c)).map(([a,s])=>{let f;if(a==="style"){if(f=q(s,t,i,c,n),!f)return null}else if(M(s)){const u=K(s,t,i,c,n);f=C(String(u),t,!1,i,c,n)}else f=C(String(s),t,!1,i,c,n);return`${a}="${I(f)}"`}).filter(a=>a!==null).join(" ");return r?" "+r:""}function Z(e,t={}){const{data:o={},yaml:i,indent:c,logger:n}=t,r=e.renderer.rules.fence;e.renderer.rules.fence=function(a,s,f,u,d){const h=a[s],$=h.info?h.info.trim():"";if($==="treebark"||$.startsWith("treebark "))try{return x(h.content,o,i,c,n)+`
`}catch(m){const l=m instanceof Error?m.message:"Unknown error";return`<div class="treebark-error"><strong>Treebark Error:</strong> ${ee(l)}</div>
`}return r?r(a,s,f,u,d):""}}function x(e,t,o,i,c){let n,r=null;if(!e.trim())throw new Error("Empty or invalid template");if(o)try{n=o.load(e)}catch(s){r=s instanceof Error?s:new Error("YAML parsing failed")}if(!n)try{n=JSON.parse(e)}catch(s){throw o&&r?new Error(`Failed to parse as YAML or JSON. YAML error: ${r.message}`):new Error(`Failed to parse as JSON: ${s instanceof Error?s.message:"Invalid format"}`)}if(!n)throw new Error("Empty or invalid template");const a={indent:i,logger:c};if(n&&typeof n=="object"&&"template"in n){const s={...t,...n.data};return P({template:n.template,data:s},a)}else return P({template:n,data:t},a)}function ee(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,o=>t[o])}return Z}));
//# sourceMappingURL=markdown-it-treebark-browser.min.js.map
