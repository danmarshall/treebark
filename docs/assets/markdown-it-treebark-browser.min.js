(function(m,y){typeof exports=="object"&&typeof module<"u"?module.exports=y():typeof define=="function"&&define.amd?define(y):(m=typeof globalThis<"u"?globalThis:m||self,m.MarkdownItTreebark=y())})(this,(function(){"use strict";const m=new Set(["div","span","p","header","footer","main","section","article","h1","h2","h3","h4","h5","h6","strong","em","blockquote","code","pre","ul","ol","li","table","thead","tbody","tr","th","td","a"]),y=new Set(["$comment","$if"]),b=new Set(["img","br","hr"]),W=new Set([...m,...y,...b]),C=new Set(["id","class","style","title","role","data-","aria-"]),_={a:new Set(["href","target","rel"]),img:new Set(["src","alt","width","height"]),table:new Set(["summary"]),th:new Set(["scope","colspan","rowspan"]),td:new Set(["scope","colspan","rowspan"]),blockquote:new Set(["cite"])},E=new Set(["$<","$>","$<=","$>=","$=","$in"]),O=new Set(["$check","$then","$else","$not","$join",...E]),D=new Set(["behavior","-moz-binding"]);function S(e,n,i=[],r){if(n===".")return e;let o=e,s=n;for(;s.startsWith("..");){let t=0,c=s;for(;c.startsWith("..");)t++,c=c.substring(2),c.startsWith("/")&&(c=c.substring(1));if(t<=i.length)o=i[i.length-t],s=c.startsWith(".")?c.substring(1):c;else return}if(s){if(r&&typeof o!="object"&&o!==null&&o!==void 0){r.error(`Cannot access property "${s}" on primitive value of type "${typeof o}"`);return}return s.split(".").reduce((t,c)=>t&&typeof t=="object"&&t!==null?t[c]:void 0,o)}return o}function k(e){return e.replace(/[&<>"']/g,n=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[n]||n)}function w(e,n,i=!0,r=[],o){return e.replace(/\{\{\{([^{]*?)\}\}\}|\{\{([^{]*?)\}\}/g,(s,t,c)=>{if(t!==void 0)return`{{${t.trim()}}}`;const a=c.trim(),u=S(n,a,r,o);return u==null?"":i?k(String(u)):String(u)})}function N(e,n){const i=[];for(const[r,o]of Object.entries(e)){const s=r;if(!/^[a-z]([a-z0-9-]*[a-z0-9])?$/.test(s)){n.warn(`CSS property "${r}" has invalid format (must be kebab-case)`);continue}if(D.has(s)){n.warn(`CSS property "${r}" is blocked for security reasons`);continue}if(o==null)continue;let t=String(o).trim();if(t.includes(";")){const u=t;t=t.split(";")[0].trim(),t&&t!==u.trim()&&n.warn(`CSS value for "${r}" contained semicolon - using only first part: "${t}"`)}if(!t)continue;const c=/url\s*\(/i.test(t),a=/url\s*\(\s*['"]?data:/i.test(t);if(c&&!a||/expression\s*\(/i.test(t)||/javascript:/i.test(t)||/@import/i.test(t)){n.warn(`CSS value for "${r}" contains potentially dangerous pattern: "${t}"`);continue}i.push(`${s}: ${t}`)}return i.join("; ").trim()}function G(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$check"in e&&typeof e.$check=="string"&&("$then"in e||"$else"in e)}function R(e,n,i,r){if(G(e)){const o=e;if(!v(o.$check,"$check",r))return"";const s=S(n,o.$check,i),c=g(s,o)?o.$then:o.$else;return c===void 0?"":R(c,n,i,r)}return typeof e=="object"&&e!==null&&!Array.isArray(e)?N(e,r):(r.error(`Style attribute must be an object with CSS properties, not ${typeof e}. Example: style: { "color": "red", "font-size": "14px" }`),"")}function q(e,n,i){const r=C.has(e)||[...C].some(t=>t.endsWith("-")&&e.startsWith(t)),o=_[n],s=o&&o.has(e);return!r&&!s?(i.warn(`Attribute "${e}" is not allowed on tag "${n}"`),!1):!0}function z(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$bind"in e}function v(e,n,i){return e==="."?!0:e.includes("..")?(i.error(`${n} does not support parent context access (..) - use interpolation {{..prop}} in content/attributes instead. Invalid: ${n}: "${e}"`),!1):e.includes("{{")?(i.error(`${n} does not support interpolation {{...}} - use literal property paths only. Invalid: ${n}: "${e}"`),!1):!0}function g(e,n){const i=[];for(const t of E)t in n&&i.push({key:t,value:n[t]});if(i.length===0){const t=!!e;return n.$not?!t:t}const r=i.map(t=>{switch(t.key){case"$<":return typeof e=="number"&&typeof t.value=="number"&&e<t.value;case"$>":return typeof e=="number"&&typeof t.value=="number"&&e>t.value;case"$<=":return typeof e=="number"&&typeof t.value=="number"&&e<=t.value;case"$>=":return typeof e=="number"&&typeof t.value=="number"&&e>=t.value;case"$=":return e===t.value;case"$in":return Array.isArray(t.value)&&t.value.includes(e);default:return!1}}),o=n.$join==="OR";let s;return o?s=r.some(t=>t):s=r.every(t=>t),n.$not?!s:s}function B(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$check"in e&&typeof e.$check=="string"}function M(e,n,i=[],r){if(!v(e.$check,"$check",r))return"";const o=S(n,e.$check,i);return g(o,e)?e.$then!==void 0?e.$then:"":e.$else!==void 0?e.$else:""}function F(e,n){if(!e||typeof e!="object"){n.error("Template object cannot be null, undefined, or non-object");return}const i=Object.entries(e);if(i.length===0){n.error("Template object must have at least one tag");return}const r=i[0];if(!r){n.error("Template object must have at least one tag");return}const[o,s]=r,t=typeof s=="string"?[s]:Array.isArray(s)?s:s?.$children||[],c=s&&typeof s=="object"&&!Array.isArray(s)?Object.fromEntries(Object.entries(s).filter(([a])=>a!=="$children")):{};return{tag:o,rest:s,children:t,attrs:c}}function K(e,n,i=[],r){const o=e;if(!o.$check)return r.error('"$if" tag requires $check attribute to specify the condition'),{valueToRender:void 0};if(!v(o.$check,"$check",r))return{valueToRender:void 0};const s=S(n,o.$check,i);typeof e=="object"&&e!==null&&!Array.isArray(e)&&"$children"in e&&r.warn('"$if" tag does not support $children, use $then and $else instead');const{$then:t,$else:c}=o;if(t!==void 0&&Array.isArray(t))return r.error('"$if" tag $then must be a string or single element object, not an array'),{valueToRender:void 0};if(c!==void 0&&Array.isArray(c))return r.error('"$if" tag $else must be a string or single element object, not an array'),{valueToRender:void 0};const u=(typeof e=="object"&&e!==null&&!Array.isArray(e)?Object.keys(e):[]).filter(d=>!O.has(d));return u.length>0&&r.warn(`"$if" tag does not support attributes: ${u.join(", ")}. Allowed: ${[...O].join(", ")}`),{valueToRender:g(s,o)?t:c}}const Y=(e,n)=>{if(!n)return e.length<=1?e[0]?.[1]??"":e.reduce((r,[,o])=>r+o,"");if(e.length===0)return"";if(e.length===1&&!e[0][1].includes("<"))return e[0][1];let i=`
`;for(let r=0;r<e.length;r++)i+=n.repeat(e[r][0])+e[r][1],r<e.length-1&&(i+=`
`);return i+=`
`,i};function I(e,n={}){const i=e.data,r=n.logger||console,o=n.indent?{indentStr:typeof n.indent=="number"?" ".repeat(n.indent):typeof n.indent=="string"?n.indent:"  ",level:0,logger:r}:{logger:r};return $(e.template,i,o)}function J(e,n,i,r,o,s,t,c=[]){const a=Y(r,s),u=a.startsWith(`
`)&&s?s.repeat(t||0):"";if(e==="$comment")return`<!--${a}${u}-->`;const f=`<${e}${U(n,i,e,c,o)}>`;return b.has(e)?f:`${f}${a}${u}</${e}>`}function $(e,n,i){const r=i.parents||[],o=i.logger;if(typeof e=="string")return w(e,n,!0,r,o);if(Array.isArray(e))return e.map(l=>$(l,n,i)).join(i.indentStr?`
`:"");const s=F(e,o);if(!s)return"";const{tag:t,rest:c,children:a,attrs:u}=s;if(!W.has(t))return o.error(`Tag "${t}" is not allowed`),"";if(t==="$comment"&&i.insideComment)return o.error("Nested comments are not allowed"),"";if(t==="$if"){const{valueToRender:l}=K(c,n,r,o);return l===void 0?"":$(l,n,i)}b.has(t)&&a.length>0&&o.warn(`Tag "${t}" is a void element and cannot have children`);const f={...i,insideComment:t==="$comment"||i.insideComment,level:(i.level||0)+1},A=l=>l===""?[]:i.indentStr&&l.includes(`
`)&&!l.includes("<")?l.split(`
`).map(p=>[f.level,p]):[[f.level,l]];let d,h;if(z(c)){if(!v(c.$bind,"$bind",o))return"";const l=S(n,c.$bind,[],o),{$bind:p,$children:P=[],...L}=c;if(!Array.isArray(l)){if(l!=null&&typeof l!="object")return o.error(`$bind resolved to primitive value of type "${typeof l}", cannot render children`),"";const j=l&&typeof l=="object"&&l!==null?l:{},T=[...r,n];return $({[t]:{...L,$children:P}},j,{...i,parents:T})}if(d=[],!b.has(t))for(const j of l){const T=[...r,n];for(const X of P){const Z=$(X,j,{...f,parents:T});d.push(...A(Z))}}h=L}else{if(d=[],!b.has(t))for(const l of a){const p=$(l,n,{...f,parents:r});d.push(...A(p))}h=u}return J(t,h,n,d,o,i.indentStr,i.level,r)}function U(e,n,i,r=[],o){const s=Object.entries(e).filter(([t])=>q(t,i,o)).map(([t,c])=>{let a;if(t==="style"){if(a=R(c,n,r,o),!a)return null}else if(B(c)){const u=M(c,n,r,o);a=w(String(u),n,!1,r,o)}else a=w(String(c),n,!1,r,o);return`${t}="${k(a)}"`}).filter(t=>t!==null).join(" ");return s?" "+s:""}function V(e,n={}){const{data:i={},yaml:r,indent:o,logger:s}=n,t=e.renderer.rules.fence;e.renderer.rules.fence=function(c,a,u,f,A){const d=c[a],h=d.info?d.info.trim():"";if(h==="treebark"||h.startsWith("treebark "))try{return H(d.content,i,r,o,s)+`
`}catch(l){const p=l instanceof Error?l.message:"Unknown error";return`<div class="treebark-error"><strong>Treebark Error:</strong> ${Q(p)}</div>
`}return t?t(c,a,u,f,A):""}}function H(e,n,i,r,o){let s,t=null;if(!e.trim())throw new Error("Empty or invalid template");if(i)try{s=i.load(e)}catch(a){t=a instanceof Error?a:new Error("YAML parsing failed")}if(!s)try{s=JSON.parse(e)}catch(a){throw i&&t?new Error(`Failed to parse as YAML or JSON. YAML error: ${t.message}`):new Error(`Failed to parse as JSON: ${a instanceof Error?a.message:"Invalid format"}`)}if(!s)throw new Error("Empty or invalid template");const c={indent:r,logger:o};if(s&&typeof s=="object"&&"template"in s){const a={...n,...s.data};return I({template:s.template,data:a},c)}else return I({template:s,data:n},c)}function Q(e){const n={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,i=>n[i])}return V}));
//# sourceMappingURL=markdown-it-treebark-browser.min.js.map
