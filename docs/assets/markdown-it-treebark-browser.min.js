(function(y,g){typeof exports=="object"&&typeof module<"u"?module.exports=g():typeof define=="function"&&define.amd?define(g):(y=typeof globalThis<"u"?globalThis:y||self,y.MarkdownItTreebark=g())})(this,(function(){"use strict";const y={error:e=>console.error(e)};function g(e){return e||y}function f(e,t){g(e).error(t)}const W=new Set(["div","span","p","header","footer","main","section","article","h1","h2","h3","h4","h5","h6","strong","em","blockquote","code","pre","ul","ol","li","table","thead","tbody","tr","th","td","a"]),N=new Set(["$comment","$if"]),A=new Set(["img","br","hr"]),G=new Set([...W,...N,...A]),O=new Set(["id","class","style","title","role","data-","aria-"]),_={a:new Set(["href","target","rel"]),img:new Set(["src","alt","width","height"]),table:new Set(["summary"]),th:new Set(["scope","colspan","rowspan"]),td:new Set(["scope","colspan","rowspan"]),blockquote:new Set(["cite"])},C=new Set(["$<","$>","$<=","$>=","$=","$in"]),R=new Set(["$check","$then","$else","$not","$join",...C]);function b(e,t,n=[]){if(t===".")return e;let o=e,i=t;for(;i.startsWith("..");){let s=0,r=i;for(;r.startsWith("..");)s++,r=r.substring(2),r.startsWith("/")&&(r=r.substring(1));if(s<=n.length)o=n[n.length-s],i=r.startsWith(".")?r.substring(1):r;else return}return i?i.split(".").reduce((s,r)=>s&&typeof s=="object"&&s!==null?s[r]:void 0,o):o}function w(e){return e.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t]||t)}function T(e,t,n=!0,o=[]){return e.replace(/\{\{\{([^{]*?)\}\}\}|\{\{([^{]*?)\}\}/g,(i,s,r)=>{if(s!==void 0)return`{{${s.trim()}}}`;const a=r.trim(),c=b(t,a,o);return c==null?"":n?w(String(c)):String(c)})}function q(e,t,n){const o=O.has(e)||[...O].some(r=>r.endsWith("-")&&e.startsWith(r)),i=_[t],s=i&&i.has(e);return!o&&!s?(f(n,`Attribute "${e}" is not allowed on tag "${t}"`),!1):!0}function M(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$bind"in e}function S(e,t,n){return e==="."?!0:e.includes("..")?(f(n,`${t} does not support parent context access (..) - use interpolation {{..prop}} in content/attributes instead. Invalid: ${t}: "${e}"`),!1):e.includes("{{")?(f(n,`${t} does not support interpolation {{...}} - use literal property paths only. Invalid: ${t}: "${e}"`),!1):!0}function k(e,t){const n=[];for(const r of C)r in t&&n.push({key:r,value:t[r]});if(n.length===0){const r=!!e;return t.$not?!r:r}const o=n.map(r=>{switch(r.key){case"$<":return typeof e=="number"&&typeof r.value=="number"&&e<r.value;case"$>":return typeof e=="number"&&typeof r.value=="number"&&e>r.value;case"$<=":return typeof e=="number"&&typeof r.value=="number"&&e<=r.value;case"$>=":return typeof e=="number"&&typeof r.value=="number"&&e>=r.value;case"$=":return e===r.value;case"$in":return Array.isArray(r.value)&&r.value.includes(e);default:return!1}}),i=t.$join==="OR";let s;return i?s=o.some(r=>r):s=o.every(r=>r),t.$not?!s:s}function B(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$check"in e&&typeof e.$check=="string"}function D(e,t,n=[],o){if(!S(e.$check,"$check",o))return"";const i=b(t,e.$check,n);return k(i,e)?e.$then!==void 0?e.$then:"":e.$else!==void 0?e.$else:""}function F(e,t){if(!e||typeof e!="object"){f(t,"Template object cannot be null, undefined, or non-object");return}const n=Object.entries(e);if(n.length===0){f(t,"Template object must have at least one tag");return}const o=n[0];if(!o){f(t,"Template object must have at least one tag");return}const[i,s]=o,r=typeof s=="string"?[s]:Array.isArray(s)?s:s?.$children||[],a=s&&typeof s=="object"&&!Array.isArray(s)?Object.fromEntries(Object.entries(s).filter(([c])=>c!=="$children")):{};return{tag:i,rest:s,children:r,attrs:a}}function Y(e,t,n=[],o){const i=e;if(!i.$check)return f(o,'"$if" tag requires $check attribute to specify the condition'),{valueToRender:void 0};if(!S(i.$check,"$check",o))return{valueToRender:void 0};const s=b(t,i.$check,n);if(typeof e=="object"&&e!==null&&!Array.isArray(e)&&"$children"in e)return f(o,'"$if" tag does not support $children, use $then and $else instead'),{valueToRender:void 0};const{$then:r,$else:a}=i;if(r!==void 0&&Array.isArray(r))return f(o,'"$if" tag $then must be a string or single element object, not an array'),{valueToRender:void 0};if(a!==void 0&&Array.isArray(a))return f(o,'"$if" tag $else must be a string or single element object, not an array'),{valueToRender:void 0};const u=(typeof e=="object"&&e!==null&&!Array.isArray(e)?Object.keys(e):[]).filter(h=>!R.has(h));return u.length>0?(f(o,`"$if" tag does not support attributes: ${u.join(", ")}. Allowed: ${[...R].join(", ")}`),{valueToRender:void 0}):{valueToRender:k(s,i)?r:a}}const J=(e,t)=>{if(!t)return e.length<=1?e[0]?.[1]??"":e.reduce((o,[,i])=>o+i,"");if(e.length===0)return"";if(e.length===1&&!e[0][1].includes("<"))return e[0][1];let n=`
`;for(let o=0;o<e.length;o++)n+=t.repeat(e[o][0])+e[o][1],o<e.length-1&&(n+=`
`);return n+=`
`,n};function I(e,t={}){const n=Array.isArray(e.data)?e.data:{...e.data,...t.data},o=t.indent?{indentStr:typeof t.indent=="number"?" ".repeat(t.indent):typeof t.indent=="string"?t.indent:"  ",level:0,logger:t.logger}:{logger:t.logger};return m(e.template,n,o)}function K(e,t,n,o,i,s,r=[],a){const c=J(o,i),u=c.startsWith(`
`)&&i?i.repeat(s||0):"";if(e==="$comment")return`<!--${c}${u}-->`;const d=`<${e}${H(t,n,e,r,a)}>`;return A.has(e)?d:`${d}${c}${u}</${e}>`}function m(e,t,n={}){const o=n.parents||[],i=n.logger;if(typeof e=="string")return T(e,t,!0,o);if(Array.isArray(e))return e.map(l=>m(l,t,n)).join(n.indentStr?`
`:"");const s=F(e,i);if(!s)return"";const{tag:r,rest:a,children:c,attrs:u}=s;if(!G.has(r))return f(i,`Tag "${r}" is not allowed`),"";if(r==="$comment"&&n.insideComment)return f(i,"Nested comments are not allowed"),"";if(r==="$if"){const{valueToRender:l}=Y(a,t,o,i);return l===void 0?"":m(l,t,n)}if(A.has(r)&&c.length>0)return f(i,`Tag "${r}" is a void element and cannot have children`),"";const d={...n,insideComment:r==="$comment"||n.insideComment,level:(n.level||0)+1},$=l=>l===""?[]:n.indentStr&&l.includes(`
`)&&!l.includes("<")?l.split(`
`).map(v=>[d.level,v]):[[d.level,l]];let h,p;if(M(a)){if(!S(a.$bind,"$bind",i))return"";const l=b(t,a.$bind,[]),{$bind:v,$children:L=[],...P}=a;if(!Array.isArray(l)){const j=l&&typeof l=="object"&&l!==null?l:{},E=[...o,t];return m({[r]:{...P,$children:L}},j,{...n,parents:E})}h=[];for(const j of l){const E=[...o,t];for(const X of L){const Z=m(X,j,{...d,parents:E});h.push(...$(Z))}}p=P}else{h=[];for(const l of c){const v=m(l,t,{...d,parents:o});h.push(...$(v))}p=u}return K(r,p,t,h,n.indentStr,n.level,o,i)}function H(e,t,n,o=[],i){const s=Object.entries(e).filter(([r])=>q(r,n,i)).map(([r,a])=>{if(B(a)){const c=D(a,t,o,i);return`${r}="${w(T(String(c),t,!1,o))}"`}else return`${r}="${w(T(String(a),t,!1,o))}"`}).join(" ");return s?" "+s:""}function U(e,t={}){const{data:n={},yaml:o,indent:i}=t,s=e.renderer.rules.fence;e.renderer.rules.fence=function(r,a,c,u,d){const $=r[a],h=$.info?$.info.trim():"";if(h==="treebark"||h.startsWith("treebark "))try{return z($.content,n,o,i)+`
`}catch(p){const l=p instanceof Error?p.message:"Unknown error";return`<div class="treebark-error"><strong>Treebark Error:</strong> ${Q(l)}</div>
`}return s?s(r,a,c,u,d):""}}function z(e,t,n,o){let i,s=null;if(!e.trim())throw new Error("Empty or invalid template");if(n)try{i=n.load(e)}catch(u){s=u instanceof Error?u:new Error("YAML parsing failed")}if(!i)try{i=JSON.parse(e)}catch(u){throw n&&s?new Error(`Failed to parse as YAML or JSON. YAML error: ${s.message}`):new Error(`Failed to parse as JSON: ${u instanceof Error?u.message:"Invalid format"}`)}if(!i)throw new Error("Empty or invalid template");const r=[],a={error:u=>r.push(u)};let c;if(i&&typeof i=="object"&&"template"in i){const u={...t,...i.data};c=I({template:i.template,data:u},{indent:o,logger:a})}else c=I({template:i,data:t},{indent:o,logger:a});if(r.length>0)throw new Error(r.join("; "));return c}function Q(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,n=>t[n])}return U}));
//# sourceMappingURL=markdown-it-treebark-browser.min.js.map
