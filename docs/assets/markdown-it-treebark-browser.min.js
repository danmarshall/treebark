(function(y,b){typeof exports=="object"&&typeof module<"u"?module.exports=b():typeof define=="function"&&define.amd?define(b):(y=typeof globalThis<"u"?globalThis:y||self,y.MarkdownItTreebark=b())})(this,(function(){"use strict";const y=new Set(["div","span","p","header","footer","main","section","article","h1","h2","h3","h4","h5","h6","strong","em","blockquote","code","pre","ul","ol","li","table","thead","tbody","tr","th","td","a"]),b=new Set(["$comment","$if"]),A=new Set(["img","br","hr"]),D=new Set([...y,...b,...A]),O=new Set(["id","class","style","title","role","data-","aria-"]),N={a:new Set(["href","target","rel"]),img:new Set(["src","alt","width","height"]),table:new Set(["summary"]),th:new Set(["scope","colspan","rowspan"]),td:new Set(["scope","colspan","rowspan"]),blockquote:new Set(["cite"])},g=new Set(["$<","$>","$<=","$>=","$=","$in"]),R=new Set(["$check","$then","$else","$not","$join",...g]),U=new Set(["behavior","-moz-binding"]),B=new Set(["__proto__","constructor","prototype"]),k=new Set(["http:","https:","mailto:","tel:","sms:","ftp:","ftps:"]),G=new Set(["href","src"]);function S(e,t,o=[],n,s){if(t===".")return e;let r=e,i=t;for(;i.startsWith("..");){let a=0,c=i;for(;c.startsWith("..");)a++,c=c.substring(2),c.startsWith("/")&&(c=c.substring(1));if(a<=o.length)r=o[o.length-a],i=c.startsWith(".")?c.substring(1):c;else return s?s(t,e,o):void 0}if(i){if(n&&typeof r!="object"&&r!==null&&r!==void 0){n.error(`Cannot access property "${i}" on primitive value of type "${typeof r}"`);return}const a=i.split(".").reduce((c,u)=>{if(B.has(u)){n&&n.warn(`Access to property "${u}" is blocked for security reasons`);return}return c&&typeof c=="object"&&c!==null?c[u]:void 0},r);return a===void 0&&s?s(t,e,o):a}return r}function _(e){return e.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t]||t)}function T(e,t,o=!0,n=[],s,r){return e.replace(/\{\{\{([^{]*?)\}\}\}|\{\{([^{]*?)\}\}/g,(i,a,c)=>{if(a!==void 0)return`{{${a.trim()}}}`;const u=c.trim(),f=S(t,u,n,s,r);return f==null?"":o?_(String(f)):String(f)})}function L(e,t){const o=[];for(const[n,s]of Object.entries(e)){const r=n;if(!/^[a-z]([a-z0-9-]*[a-z0-9])?$/.test(r)){t.warn(`CSS property "${n}" has invalid format (must be kebab-case)`);continue}if(U.has(r)){t.warn(`CSS property "${n}" is blocked for security reasons`);continue}if(s==null)continue;let i=String(s).trim();if(i.includes(";")){const u=i;i=i.split(";")[0].trim(),i&&i!==u.trim()&&t.warn(`CSS value for "${n}" contained semicolon - using only first part: "${i}"`)}if(!i)continue;const a=/url\s*\(/i.test(i),c=/url\s*\(\s*['"]?data:/i.test(i);if(a&&!c||/expression\s*\(/i.test(i)||/javascript:/i.test(i)||/@import/i.test(i)){t.warn(`CSS value for "${n}" contains potentially dangerous pattern: "${i}"`);continue}o.push(`${r}: ${i}`)}return o.join("; ").trim()}function F(e,t,o,n,s){if(e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$check"in e&&typeof e.$check=="string"){const r=e;if(!v(r.$check,"$check",n))return"";const i=S(t,r.$check,o,n,s),c=j(i,r)?r.$then:r.$else;return c===void 0?"":typeof c=="object"&&c!==null&&!Array.isArray(c)?L(c,n):""}return typeof e=="object"&&e!==null&&!Array.isArray(e)?L(e,n):(n.error(`Style attribute must be an object with CSS properties, not ${typeof e}. Example: style: { "color": "red", "font-size": "14px" }`),"")}function M(e,t,o){const n=O.has(e)||[...O].some(i=>i.endsWith("-")&&e.startsWith(i)),s=N[t],r=s&&s.has(e);return!n&&!r?(o.warn(`Attribute "${e}" is not allowed on tag "${t}"`),!1):!0}function q(e,t,o){const n=t.trim();if(!n||n.startsWith("/")||n.startsWith("#")||n.startsWith("?")||!n.includes(":"))return n;const s=n.indexOf(":");if(s===-1)return n;const r=n.substring(0,s+1).toLowerCase();return k.has(r)?n:(o.warn(`Attribute "${e}" contains blocked protocol "${r}". Allowed protocols: ${[...k].join(", ")}, or relative URLs`),null)}function z(e,t,o){return G.has(e)?q(e,t,o):t}function K(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$bind"in e}function v(e,t,o){return e==="."?!0:e.includes("..")?(o.error(`${t} does not support parent context access (..) - use interpolation {{..prop}} in content/attributes instead. Invalid: ${t}: "${e}"`),!1):e.includes("{{")?(o.error(`${t} does not support interpolation {{...}} - use literal property paths only. Invalid: ${t}: "${e}"`),!1):!0}function j(e,t){const o=[];for(const i of g)i in t&&o.push({key:i,value:t[i]});if(o.length===0){const i=!!e;return t.$not?!i:i}const n=o.map(i=>{switch(i.key){case"$<":return typeof e=="number"&&typeof i.value=="number"&&e<i.value;case"$>":return typeof e=="number"&&typeof i.value=="number"&&e>i.value;case"$<=":return typeof e=="number"&&typeof i.value=="number"&&e<=i.value;case"$>=":return typeof e=="number"&&typeof i.value=="number"&&e>=i.value;case"$=":return e===i.value;case"$in":return Array.isArray(i.value)&&i.value.includes(e);default:return!1}}),s=t.$join==="OR";let r;return s?r=n.some(i=>i):r=n.every(i=>i),t.$not?!r:r}function Y(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$check"in e&&typeof e.$check=="string"}function V(e,t,o=[],n,s){if(!v(e.$check,"$check",n))return"";const r=S(t,e.$check,o,n,s);return j(r,e)?e.$then!==void 0?e.$then:"":e.$else!==void 0?e.$else:""}function J(e,t){if(!e||typeof e!="object"){t.error("Template object cannot be null, undefined, or non-object");return}const o=Object.entries(e);if(o.length===0){t.error("Template object must have at least one tag");return}const n=o[0];if(!n){t.error("Template object must have at least one tag");return}const[s,r]=n,i=typeof r=="string"?[r]:Array.isArray(r)?r:r?.$children||[],a=r&&typeof r=="object"&&!Array.isArray(r)?Object.fromEntries(Object.entries(r).filter(([c])=>c!=="$children")):{};return{tag:s,rest:r,children:i,attrs:a}}function H(e,t,o=[],n,s){const r=e;if(!r.$check)return n.error('"$if" tag requires $check attribute to specify the condition'),{valueToRender:void 0};if(!v(r.$check,"$check",n))return{valueToRender:void 0};const i=S(t,r.$check,o,n,s);typeof e=="object"&&e!==null&&!Array.isArray(e)&&"$children"in e&&n.warn('"$if" tag does not support $children, use $then and $else instead');const{$then:a,$else:c}=r;if(a!==void 0&&Array.isArray(a))return n.error('"$if" tag $then must be a string or single element object, not an array'),{valueToRender:void 0};if(c!==void 0&&Array.isArray(c))return n.error('"$if" tag $else must be a string or single element object, not an array'),{valueToRender:void 0};const f=(typeof e=="object"&&e!==null&&!Array.isArray(e)?Object.keys(e):[]).filter(p=>!R.has(p));return f.length>0&&n.warn(`"$if" tag does not support attributes: ${f.join(", ")}. Allowed: ${[...R].join(", ")}`),{valueToRender:j(i,r)?a:c}}const Q=(e,t)=>{if(!t)return e.length<=1?e[0]?.[1]??"":e.reduce((n,[,s])=>n+s,"");if(e.length===0)return"";if(e.length===1&&!e[0][1].includes("<"))return e[0][1];let o=`
`;for(let n=0;n<e.length;n++)o+=t.repeat(e[n][0])+e[n][1],n<e.length-1&&(o+=`
`);return o+=`
`,o};function I(e,t={}){const o=e.data,n=t.logger||console,s=t.propertyFallback,r=t.indent?{indentStr:typeof t.indent=="number"?" ".repeat(t.indent):typeof t.indent=="string"?t.indent:"  ",level:0,logger:n,getOuterProperty:s}:{logger:n,getOuterProperty:s};return h(e.template,o,r)}function X(e,t,o,n,s,r,i,a=[],c){const u=Q(n,r),f=u.startsWith(`
`)&&r?r.repeat(i||0):"";if(e==="$comment")return`<!--${u}${f}-->`;const d=`<${e}${Z(t,o,e,a,s,c)}>`;return A.has(e)?d:`${d}${u}${f}</${e}>`}function h(e,t,o){const n=o.parents||[],s=o.logger,r=o.getOuterProperty;if(typeof e=="string")return T(e,t,!0,n,s,r);if(Array.isArray(e))return e.map(l=>h(l,t,o)).join(o.indentStr?`
`:"");const i=J(e,s);if(!i)return"";const{tag:a,rest:c,children:u,attrs:f}=i;if(!D.has(a))return s.error(`Tag "${a}" is not allowed`),"";if(a==="$comment"&&o.insideComment)return s.error("Nested comments are not allowed"),"";if(a==="$if"){const{valueToRender:l}=H(c,t,n,s,r);return l===void 0?"":h(l,t,o)}A.has(a)&&u.length>0&&s.warn(`Tag "${a}" is a void element and cannot have children`);const d={...o,insideComment:a==="$comment"||o.insideComment,level:(o.level||0)+1},$=l=>l===""?[]:o.indentStr&&l.includes(`
`)&&!l.includes("<")?l.split(`
`).map(w=>[d.level,w]):[[d.level,l]];let p,m;if(K(c)){if(!v(c.$bind,"$bind",s))return"";const l=S(t,c.$bind,[],s,r),{$bind:w,$children:P=[],...W}=c;if(!Array.isArray(l)){if(l!=null&&typeof l!="object")return s.error(`$bind resolved to primitive value of type "${typeof l}", cannot render children`),"";const E=l&&typeof l=="object"&&l!==null?l:{},C=[...n,t];return h({[a]:{...W,$children:P}},E,{...o,parents:C})}if(p=[],!A.has(a))for(const E of l){const C=[...n,t];for(const ne of P){const re=h(ne,E,{...d,parents:C});p.push(...$(re))}}m=W}else{if(p=[],!A.has(a))for(const l of u){const w=h(l,t,{...d,parents:n});p.push(...$(w))}m=f}return X(a,m,t,p,s,o.indentStr,o.level,n,r)}function Z(e,t,o,n=[],s,r){const i=Object.entries(e).filter(([a])=>M(a,o,s)).map(([a,c])=>{let u;if(a==="style"){if(u=F(c,t,n,s,r),!u)return null}else if(Y(c)){const d=V(c,t,n,s,r);u=T(String(d),t,!1,n,s,r)}else u=T(String(c),t,!1,n,s,r);const f=z(a,u,s);return f==null?null:`${a}="${_(f)}"`}).filter(a=>a!==null).join(" ");return i?" "+i:""}function x(e,t={}){const{data:o={},yaml:n,indent:s,logger:r}=t,i=e.renderer.rules.fence;e.renderer.rules.fence=function(a,c,u,f,d){const $=a[c],p=$.info?$.info.trim():"";if(p==="treebark"||p.startsWith("treebark "))try{return ee($.content,o,n,s,r)+`
`}catch(m){const l=m instanceof Error?m.message:"Unknown error";return`<div class="treebark-error"><strong>Treebark Error:</strong> ${te(l)}</div>
`}return i?i(a,c,u,f,d):""}}function ee(e,t,o,n,s){let r,i=null;if(!e.trim())throw new Error("Empty or invalid template");if(o)try{r=o.load(e)}catch(c){i=c instanceof Error?c:new Error("YAML parsing failed")}if(!r)try{r=JSON.parse(e)}catch(c){throw o&&i?new Error(`Failed to parse as YAML or JSON. YAML error: ${i.message}`):new Error(`Failed to parse as JSON: ${c instanceof Error?c.message:"Invalid format"}`)}if(!r)throw new Error("Empty or invalid template");const a={indent:n,logger:s};if(r&&typeof r=="object"&&"template"in r){const c={...t,...r.data};return I({template:r.template,data:c},a)}else return I({template:r,data:t},a)}function te(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,o=>t[o])}return x}));
//# sourceMappingURL=markdown-it-treebark-browser.min.js.map
