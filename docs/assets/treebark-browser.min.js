(function(h,y){typeof exports=="object"&&typeof module<"u"?y(exports):typeof define=="function"&&define.amd?define(["exports"],y):(h=typeof globalThis<"u"?globalThis:h||self,y(h.Treebark={}))})(this,(function(h){"use strict";const y=new Set(["div","span","p","header","footer","main","section","article","h1","h2","h3","h4","h5","h6","strong","em","blockquote","code","pre","ul","ol","li","table","thead","tbody","tr","th","td","a"]),D=new Set(["$comment","$if"]),m=new Set(["img","br","hr"]),G=new Set([...y,...D,...m]),R=new Set(["id","class","style","title","role","data-","aria-"]),U={a:new Set(["href","target","rel"]),img:new Set(["src","alt","width","height"]),table:new Set(["summary"]),th:new Set(["scope","colspan","rowspan"]),td:new Set(["scope","colspan","rowspan"]),blockquote:new Set(["cite"])},_=new Set(["$<","$>","$<=","$>=","$=","$in"]),E=new Set(["$check","$then","$else","$not","$join",..._]),B=new Set(["behavior","-moz-binding"]),N=new Set(["__proto__","constructor","prototype"]),L=new Set(["http:","https:","mailto:","tel:","sms:","ftp:","ftps:"]),z=new Set(["href","src"]);function b(e,n,o=[],t,s){if(n===".")return e;let i=e,r=n;for(;r.startsWith("..");){let l=0,c=r;for(;c.startsWith("..");)l++,c=c.substring(2),c.startsWith("/")&&(c=c.substring(1));if(l<=o.length)i=o[o.length-l],r=c.startsWith(".")?c.substring(1):c;else return s?s(n,e,o):void 0}if(r){if(t&&typeof i!="object"&&i!==null&&i!==void 0){t.error(`Cannot access property "${r}" on primitive value of type "${typeof i}"`);return}const l=r.split(".").reduce((c,a)=>{if(N.has(a)){t&&t.warn(`Access to property "${a}" is blocked for security reasons`);return}return c&&typeof c=="object"&&c!==null?c[a]:void 0},i);return l===void 0&&s?s(n,e,o):l}return i}function P(e){return e.replace(/[&<>"']/g,n=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[n]||n)}function v(e,n,o=!0,t=[],s,i){return e.replace(/\{\{\{([^{]*?)\}\}\}|\{\{([^{]*?)\}\}/g,(r,l,c)=>{if(l!==void 0)return`{{${l.trim()}}}`;const a=c.trim(),f=b(n,a,t,s,i);return f==null?"":o?P(String(f)):String(f)})}function I(e,n){const o=[];for(const[t,s]of Object.entries(e)){const i=t;if(!/^[a-z]([a-z0-9-]*[a-z0-9])?$/.test(i)){n.warn(`CSS property "${t}" has invalid format (must be kebab-case)`);continue}if(B.has(i)){n.warn(`CSS property "${t}" is blocked for security reasons`);continue}if(s==null)continue;let r=String(s).trim();if(r.includes(";")){const a=r;r=r.split(";")[0].trim(),r&&r!==a.trim()&&n.warn(`CSS value for "${t}" contained semicolon - using only first part: "${r}"`)}if(!r)continue;const l=/url\s*\(/i.test(r),c=/url\s*\(\s*['"]?data:/i.test(r);if(l&&!c||/expression\s*\(/i.test(r)||/javascript:/i.test(r)||/@import/i.test(r)){n.warn(`CSS value for "${t}" contains potentially dangerous pattern: "${r}"`);continue}o.push(`${i}: ${r}`)}return o.join("; ").trim()}function K(e,n,o,t,s){if(e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$check"in e&&typeof e.$check=="string"){const i=e;if(!S(i.$check,"$check",t))return"";const r=b(n,i.$check,o,t,s),c=w(r,i)?i.$then:i.$else;return c===void 0?"":typeof c=="object"&&c!==null&&!Array.isArray(c)?I(c,t):""}return typeof e=="object"&&e!==null&&!Array.isArray(e)?I(e,t):(t.error(`Style attribute must be an object with CSS properties, not ${typeof e}. Example: style: { "color": "red", "font-size": "14px" }`),"")}function q(e,n,o){const t=R.has(e)||[...R].some(r=>r.endsWith("-")&&e.startsWith(r)),s=U[n],i=s&&s.has(e);return!t&&!i?(o.warn(`Attribute "${e}" is not allowed on tag "${n}"`),!1):!0}function V(e,n,o){if(!z.has(e))return n;const t=n.trim();if(!t||t.startsWith("/")||t.startsWith("#")||t.startsWith("?")||!t.includes(":"))return t;const s=t.indexOf(":");if(s===-1)return t;const i=t.substring(0,s+1).toLowerCase();return L.has(i)?t:(o.warn(`Attribute "${e}" contains blocked protocol "${i}". Allowed protocols: ${[...L].join(", ")}, or relative URLs`),"")}function g(e,n,o,t){return q(e,n,t)?V(e,o,t):null}function F(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$bind"in e}function S(e,n,o){return e==="."?!0:e.includes("..")?(o.error(`${n} does not support parent context access (..) - use interpolation {{..prop}} in content/attributes instead. Invalid: ${n}: "${e}"`),!1):e.includes("{{")?(o.error(`${n} does not support interpolation {{...}} - use literal property paths only. Invalid: ${n}: "${e}"`),!1):!0}function w(e,n){const o=[];for(const r of _)r in n&&o.push({key:r,value:n[r]});if(o.length===0){const r=!!e;return n.$not?!r:r}const t=o.map(r=>{switch(r.key){case"$<":return typeof e=="number"&&typeof r.value=="number"&&e<r.value;case"$>":return typeof e=="number"&&typeof r.value=="number"&&e>r.value;case"$<=":return typeof e=="number"&&typeof r.value=="number"&&e<=r.value;case"$>=":return typeof e=="number"&&typeof r.value=="number"&&e>=r.value;case"$=":return e===r.value;case"$in":return Array.isArray(r.value)&&r.value.includes(e);default:return!1}}),s=n.$join==="OR";let i;return s?i=t.some(r=>r):i=t.every(r=>r),n.$not?!i:i}function M(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$check"in e&&typeof e.$check=="string"}function Y(e,n,o=[],t,s){if(!S(e.$check,"$check",t))return"";const i=b(n,e.$check,o,t,s);return w(i,e)?e.$then!==void 0?e.$then:"":e.$else!==void 0?e.$else:""}function H(e,n){if(!e||typeof e!="object"){n.error("Template object cannot be null, undefined, or non-object");return}const o=Object.entries(e);if(o.length===0){n.error("Template object must have at least one tag");return}const t=o[0];if(!t){n.error("Template object must have at least one tag");return}const[s,i]=t,r=typeof i=="string"?[i]:Array.isArray(i)?i:i?.$children||[],l=i&&typeof i=="object"&&!Array.isArray(i)?Object.fromEntries(Object.entries(i).filter(([c])=>c!=="$children")):{};return{tag:s,rest:i,children:r,attrs:l}}function J(e,n,o=[],t,s){const i=e;if(!i.$check)return t.error('"$if" tag requires $check attribute to specify the condition'),{valueToRender:void 0};if(!S(i.$check,"$check",t))return{valueToRender:void 0};const r=b(n,i.$check,o,t,s);typeof e=="object"&&e!==null&&!Array.isArray(e)&&"$children"in e&&t.warn('"$if" tag does not support $children, use $then and $else instead');const{$then:l,$else:c}=i;if(l!==void 0&&Array.isArray(l))return t.error('"$if" tag $then must be a string or single element object, not an array'),{valueToRender:void 0};if(c!==void 0&&Array.isArray(c))return t.error('"$if" tag $else must be a string or single element object, not an array'),{valueToRender:void 0};const f=(typeof e=="object"&&e!==null&&!Array.isArray(e)?Object.keys(e):[]).filter($=>!E.has($));return f.length>0&&t.warn(`"$if" tag does not support attributes: ${f.join(", ")}. Allowed: ${[...E].join(", ")}`),{valueToRender:w(r,i)?l:c}}const Q=(e,n)=>{if(!n)return e.length<=1?e[0]?.[1]??"":e.reduce((t,[,s])=>t+s,"");if(e.length===0)return"";if(e.length===1&&!e[0][1].includes("<"))return e[0][1];let o=`
`;for(let t=0;t<e.length;t++)o+=n.repeat(e[t][0])+e[t][1],t<e.length-1&&(o+=`
`);return o+=`
`,o};function X(e,n={}){const o=e.data,t=n.logger||console,s=n.propertyFallback,i=n.indent?{indentStr:typeof n.indent=="number"?" ".repeat(n.indent):typeof n.indent=="string"?n.indent:"  ",level:0,logger:t,getOuterProperty:s}:{logger:t,getOuterProperty:s};return p(e.template,o,i)}function Z(e,n,o,t,s,i,r,l=[],c){const a=Q(t,i),f=a.startsWith(`
`)&&i?i.repeat(r||0):"";if(e==="$comment")return`<!--${a}${f}-->`;const d=`<${e}${x(n,o,e,l,s,c)}>`;return m.has(e)?d:`${d}${a}${f}</${e}>`}function p(e,n,o){const t=o.parents||[],s=o.logger,i=o.getOuterProperty;if(typeof e=="string")return v(e,n,!0,t,s,i);if(Array.isArray(e))return e.map(u=>p(u,n,o)).join(o.indentStr?`
`:"");const r=H(e,s);if(!r)return"";const{tag:l,rest:c,children:a,attrs:f}=r;if(!G.has(l))return s.error(`Tag "${l}" is not allowed`),"";if(l==="$comment"&&o.insideComment)return s.error("Nested comments are not allowed"),"";if(l==="$if"){const{valueToRender:u}=J(c,n,t,s,i);return u===void 0?"":p(u,n,o)}m.has(l)&&a.length>0&&s.warn(`Tag "${l}" is a void element and cannot have children`);const d={...o,insideComment:l==="$comment"||o.insideComment,level:(o.level||0)+1},T=u=>u===""?[]:o.indentStr&&u.includes(`
`)&&!u.includes("<")?u.split(`
`).map(A=>[d.level,A]):[[d.level,u]];let $,j;if(F(c)){if(!S(c.$bind,"$bind",s))return"";const u=b(n,c.$bind,[],s,i),{$bind:A,$children:k=[],...W}=c;if(!Array.isArray(u)){if(u!=null&&typeof u!="object")return s.error(`$bind resolved to primitive value of type "${typeof u}", cannot render children`),"";const C=u&&typeof u=="object"&&u!==null?u:{},O=[...t,n];return p({[l]:{...W,$children:k}},C,{...o,parents:O})}if($=[],!m.has(l))for(const C of u){const O=[...t,n];for(const ee of k){const te=p(ee,C,{...d,parents:O});$.push(...T(te))}}j=W}else{if($=[],!m.has(l))for(const u of a){const A=p(u,n,{...d,parents:t});$.push(...T(A))}j=f}return Z(l,j,n,$,s,o.indentStr,o.level,t,i)}function x(e,n,o,t=[],s,i){const r=Object.entries(e).map(([l,c])=>{let a;if(l==="style"){if(a=K(c,n,t,s,i),!a)return null;const f=g(l,o,a,s);if(f===null)return null;a=f}else{if(M(c)){const d=Y(c,n,t,s,i);a=v(String(d),n,!1,t,s,i)}else a=v(String(c),n,!1,t,s,i);const f=g(l,o,a,s);if(f===null||!f)return null;a=f}return`${l}="${P(a)}"`}).filter(l=>l!==null).join(" ");return r?" "+r:""}h.renderToString=X,Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})}));
//# sourceMappingURL=treebark-browser.min.js.map
