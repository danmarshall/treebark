(function(h,b){typeof exports=="object"&&typeof module<"u"?b(exports):typeof define=="function"&&define.amd?define(["exports"],b):(h=typeof globalThis<"u"?globalThis:h||self,b(h.Treebark={}))})(this,(function(h){"use strict";const b=new Set(["div","span","p","header","footer","main","section","article","h1","h2","h3","h4","h5","h6","strong","em","blockquote","code","pre","ul","ol","li","table","thead","tbody","tr","th","td","a"]),L=new Set(["$comment","$if"]),m=new Set(["img","br","hr"]),W=new Set([...b,...L,...m]),O=new Set(["id","class","style","title","role","data-","aria-"]),G={a:new Set(["href","target","rel"]),img:new Set(["src","alt","width","height"]),table:new Set(["summary"]),th:new Set(["scope","colspan","rowspan"]),td:new Set(["scope","colspan","rowspan"]),blockquote:new Set(["cite"])},R=new Set(["$<","$>","$<=","$>=","$=","$in"]),E=new Set(["$check","$then","$else","$not","$join",...R]),z=new Set(["behavior","-moz-binding"]);function y(e,n,o=[],i,s){if(n===".")return e;let r=e,t=n;for(;t.startsWith("..");){let a=0,c=t;for(;c.startsWith("..");)a++,c=c.substring(2),c.startsWith("/")&&(c=c.substring(1));if(a<=o.length)r=o[o.length-a],t=c.startsWith(".")?c.substring(1):c;else return s?s(n,e,o):void 0}if(t){if(i&&typeof r!="object"&&r!==null&&r!==void 0){i.error(`Cannot access property "${t}" on primitive value of type "${typeof r}"`);return}const a=t.split(".").reduce((c,u)=>c&&typeof c=="object"&&c!==null?c[u]:void 0,r);return a===void 0&&s?s(n,e,o):a}return r}function I(e){return e.replace(/[&<>"']/g,n=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[n]||n)}function w(e,n,o=!0,i=[],s,r){return e.replace(/\{\{\{([^{]*?)\}\}\}|\{\{([^{]*?)\}\}/g,(t,a,c)=>{if(a!==void 0)return`{{${a.trim()}}}`;const u=c.trim(),f=y(n,u,i,s,r);return f==null?"":o?I(String(f)):String(f)})}function P(e,n){const o=[];for(const[i,s]of Object.entries(e)){const r=i;if(!/^[a-z]([a-z0-9-]*[a-z0-9])?$/.test(r)){n.warn(`CSS property "${i}" has invalid format (must be kebab-case)`);continue}if(z.has(r)){n.warn(`CSS property "${i}" is blocked for security reasons`);continue}if(s==null)continue;let t=String(s).trim();if(t.includes(";")){const u=t;t=t.split(";")[0].trim(),t&&t!==u.trim()&&n.warn(`CSS value for "${i}" contained semicolon - using only first part: "${t}"`)}if(!t)continue;const a=/url\s*\(/i.test(t),c=/url\s*\(\s*['"]?data:/i.test(t);if(a&&!c||/expression\s*\(/i.test(t)||/javascript:/i.test(t)||/@import/i.test(t)){n.warn(`CSS value for "${i}" contains potentially dangerous pattern: "${t}"`);continue}o.push(`${r}: ${t}`)}return o.join("; ").trim()}function N(e,n,o,i,s){if(e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$check"in e&&typeof e.$check=="string"){const r=e;if(!A(r.$check,"$check",i))return"";const t=y(n,r.$check,o,i,s),c=S(t,r)?r.$then:r.$else;return c===void 0?"":typeof c=="object"&&c!==null&&!Array.isArray(c)?P(c,i):""}return typeof e=="object"&&e!==null&&!Array.isArray(e)?P(e,i):(i.error(`Style attribute must be an object with CSS properties, not ${typeof e}. Example: style: { "color": "red", "font-size": "14px" }`),"")}function q(e,n,o){const i=O.has(e)||[...O].some(t=>t.endsWith("-")&&e.startsWith(t)),s=G[n],r=s&&s.has(e);return!i&&!r?(o.warn(`Attribute "${e}" is not allowed on tag "${n}"`),!1):!0}function B(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$bind"in e}function A(e,n,o){return e==="."?!0:e.includes("..")?(o.error(`${n} does not support parent context access (..) - use interpolation {{..prop}} in content/attributes instead. Invalid: ${n}: "${e}"`),!1):e.includes("{{")?(o.error(`${n} does not support interpolation {{...}} - use literal property paths only. Invalid: ${n}: "${e}"`),!1):!0}function S(e,n){const o=[];for(const t of R)t in n&&o.push({key:t,value:n[t]});if(o.length===0){const t=!!e;return n.$not?!t:t}const i=o.map(t=>{switch(t.key){case"$<":return typeof e=="number"&&typeof t.value=="number"&&e<t.value;case"$>":return typeof e=="number"&&typeof t.value=="number"&&e>t.value;case"$<=":return typeof e=="number"&&typeof t.value=="number"&&e<=t.value;case"$>=":return typeof e=="number"&&typeof t.value=="number"&&e>=t.value;case"$=":return e===t.value;case"$in":return Array.isArray(t.value)&&t.value.includes(e);default:return!1}}),s=n.$join==="OR";let r;return s?r=i.some(t=>t):r=i.every(t=>t),n.$not?!r:r}function F(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$check"in e&&typeof e.$check=="string"}function K(e,n,o=[],i,s){if(!A(e.$check,"$check",i))return"";const r=y(n,e.$check,o,i,s);return S(r,e)?e.$then!==void 0?e.$then:"":e.$else!==void 0?e.$else:""}function U(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&"$check"in e&&typeof e.$check=="string"}function V(e,n,o=[],i,s){if(!A(n.$check,"$check",i))return!1;const r=y(e,n.$check,o,i,s);return S(r,n)}function M(e,n){if(!e||typeof e!="object"){n.error("Template object cannot be null, undefined, or non-object");return}const o=Object.entries(e);if(o.length===0){n.error("Template object must have at least one tag");return}const i=o[0];if(!i){n.error("Template object must have at least one tag");return}const[s,r]=i,t=typeof r=="string"?[r]:Array.isArray(r)?r:r?.$children||[],a=r&&typeof r=="object"&&!Array.isArray(r)?Object.fromEntries(Object.entries(r).filter(([c])=>c!=="$children")):{};return{tag:s,rest:r,children:t,attrs:a}}function Y(e,n,o=[],i,s){const r=e;if(!r.$check)return i.error('"$if" tag requires $check attribute to specify the condition'),{valueToRender:void 0};if(!A(r.$check,"$check",i))return{valueToRender:void 0};const t=y(n,r.$check,o,i,s);typeof e=="object"&&e!==null&&!Array.isArray(e)&&"$children"in e&&i.warn('"$if" tag does not support $children, use $then and $else instead');const{$then:a,$else:c}=r;if(a!==void 0&&Array.isArray(a))return i.error('"$if" tag $then must be a string or single element object, not an array'),{valueToRender:void 0};if(c!==void 0&&Array.isArray(c))return i.error('"$if" tag $else must be a string or single element object, not an array'),{valueToRender:void 0};const f=(typeof e=="object"&&e!==null&&!Array.isArray(e)?Object.keys(e):[]).filter($=>!E.has($));return f.length>0&&i.warn(`"$if" tag does not support attributes: ${f.join(", ")}. Allowed: ${[...E].join(", ")}`),{valueToRender:S(t,r)?a:c}}const H=(e,n)=>{if(!n)return e.length<=1?e[0]?.[1]??"":e.reduce((i,[,s])=>i+s,"");if(e.length===0)return"";if(e.length===1&&!e[0][1].includes("<"))return e[0][1];let o=`
`;for(let i=0;i<e.length;i++)o+=n.repeat(e[i][0])+e[i][1],i<e.length-1&&(o+=`
`);return o+=`
`,o};function J(e,n={}){const o=e.data,i=n.logger||console,s=n.propertyFallback,r=n.indent?{indentStr:typeof n.indent=="number"?" ".repeat(n.indent):typeof n.indent=="string"?n.indent:"  ",level:0,logger:i,getOuterProperty:s}:{logger:i,getOuterProperty:s};return p(e.template,o,r)}function Q(e,n,o,i,s,r,t,a=[],c){const u=H(i,r),f=u.startsWith(`
`)&&r?r.repeat(t||0):"";if(e==="$comment")return`<!--${u}${f}-->`;const d=`<${e}${X(n,o,e,a,s,c)}>`;return m.has(e)?d:`${d}${u}${f}</${e}>`}function p(e,n,o){const i=o.parents||[],s=o.logger,r=o.getOuterProperty;if(typeof e=="string")return w(e,n,!0,i,s,r);if(Array.isArray(e))return e.map(l=>p(l,n,o)).join(o.indentStr?`
`:"");const t=M(e,s);if(!t)return"";const{tag:a,rest:c,children:u,attrs:f}=t;if(!W.has(a))return s.error(`Tag "${a}" is not allowed`),"";if(a==="$comment"&&o.insideComment)return s.error("Nested comments are not allowed"),"";if(a==="$if"){const{valueToRender:l}=Y(c,n,i,s,r);return l===void 0?"":p(l,n,o)}m.has(a)&&u.length>0&&s.warn(`Tag "${a}" is a void element and cannot have children`);const d={...o,insideComment:a==="$comment"||o.insideComment,level:(o.level||0)+1},C=l=>l===""?[]:o.indentStr&&l.includes(`
`)&&!l.includes("<")?l.split(`
`).map(v=>[d.level,v]):[[d.level,l]];let $,k;if(B(c)){if(!A(c.$bind,"$bind",s))return"";const l=y(n,c.$bind,[],s,r),{$bind:v,$filter:g,$children:_=[],...D}=c;if(!Array.isArray(l)){if(l!=null&&typeof l!="object")return s.error(`$bind resolved to primitive value of type "${typeof l}", cannot render children`),"";const j=l&&typeof l=="object"&&l!==null?l:{},T=[...i,n];return p({[a]:{...D,$children:_}},j,{...o,parents:T})}if($=[],!m.has(a))for(const j of l){const T=[...i,n];if(!(g&&U(g)&&!V(j,g,T,s,r)))for(const Z of _){const x=p(Z,j,{...d,parents:T});$.push(...C(x))}}k=D}else{if($=[],!m.has(a))for(const l of u){const v=p(l,n,{...d,parents:i});$.push(...C(v))}k=f}return Q(a,k,n,$,s,o.indentStr,o.level,i,r)}function X(e,n,o,i=[],s,r){const t=Object.entries(e).filter(([a])=>q(a,o,s)).map(([a,c])=>{let u;if(a==="style"){if(u=N(c,n,i,s,r),!u)return null}else if(F(c)){const f=K(c,n,i,s,r);u=w(String(f),n,!1,i,s,r)}else u=w(String(c),n,!1,i,s,r);return`${a}="${I(u)}"`}).filter(a=>a!==null).join(" ");return t?" "+t:""}h.renderToString=J,Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})}));
//# sourceMappingURL=treebark-browser.min.js.map
