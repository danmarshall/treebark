<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treebark Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
        }
        .demo-section {
            margin: 2rem 0;
            padding: 1rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .demo-title {
            color: #333;
            border-bottom: 2px solid #007acc;
            padding-bottom: 0.5rem;
        }
        .schema {
            background: #f5f5f5;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
        }
        .result {
            border: 1px solid #007acc;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .card {
            border: 1px solid #ddd;
            padding: 1rem;
            border-radius: 8px;
            background: #fafafa;
        }
        .user-card {
            border: 1px solid #007acc;
            padding: 1rem;
            border-radius: 8px;
            background: #f0f8ff;
        }
        .product-card {
            border: 1px solid #28a745;
            padding: 1rem;
            border-radius: 8px;
            background: #f8fff8;
        }
        .error {
            color: #dc3545;
            background: #ffe6e6;
            padding: 0.5rem;
            border-radius: 4px;
            margin: 0.5rem 0;
        }
    </style>
</head>
<body>
    <h1>ðŸŒ³ Treebark Demo</h1>
    <p>Safe tree structures for Markdown and content-driven apps.</p>

    <div class="demo-section">
        <h2 class="demo-title">Hello World</h2>
        <div class="schema">{ "div": "Hello world" }</div>
        <div class="result" id="hello-world"></div>
    </div>

    <div class="demo-section">
        <h2 class="demo-title">Element with Attributes</h2>
        <div class="schema">
{
  "div": {
    "class": "card",
    "$children": ["Hello from a card!"]
  }
}
        </div>
        <div class="result" id="card-example"></div>
    </div>

    <div class="demo-section">
        <h2 class="demo-title">Data Binding</h2>
        <div class="schema">
{
  "div": {
    "class": "user-card",
    "$children": [
      { "h2": "{{name}}" },
      { "p": "{{email}}" }
    ]
  }
}
Data: { "name": "Alice Johnson", "email": "alice@example.com" }
        </div>
        <div class="result" id="data-binding"></div>
    </div>

    <div class="demo-section">
        <h2 class="demo-title">Array Binding</h2>
        <div class="schema">
{
  "ul": {
    "$bind": "products",
    "$children": [
      { "li": "{{name}} â€” {{price}}" }
    ]
  }
}
Data: {
  "products": [
    { "name": "Laptop", "price": "$999" },
    { "name": "Phone", "price": "$499" },
    { "name": "Tablet", "price": "$299" }
  ]
}
        </div>
        <div class="result" id="array-binding"></div>
    </div>

    <div class="demo-section">
        <h2 class="demo-title">Self-Contained Template</h2>
        <div class="schema">
{
  "$template": {
    "div": {
      "class": "product-card",
      "$children": [
        { "h2": "{{name}}" },
        { "p": "Only {{price}}!" }
      ]
    }
  },
  "$data": {
    "name": "Gaming Laptop",
    "price": "$1299"
  }
}
        </div>
        <div class="result" id="self-contained"></div>
    </div>

    <div class="demo-section">
        <h2 class="demo-title">Mixed Content</h2>
        <div class="schema">
{
  "div": {
    "$children": [
      "Hello ",
      { "span": { "style": "color: blue;", "$children": ["World"] } },
      "!"
    ]
  }
}
        </div>
        <div class="result" id="mixed-content"></div>
    </div>

    <div class="demo-section">
        <h2 class="demo-title">Security Demo</h2>
        <div class="schema">Trying to use disallowed tag: { "script": "alert('XSS')" }</div>
        <div class="result" id="security-demo"></div>
    </div>

    <script type="module">
        // This would normally import from 'treebark' but for the demo we'll inline a simplified version
        
        // Simplified treebark implementation for demo
        const DEFAULT_ALLOWED_TAGS = new Set([
            'div', 'span', 'p', 'header', 'footer', 'main', 'section', 'article',
            'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'strong', 'em', 'blockquote', 'code', 'pre',
            'ul', 'ol', 'li', 'table', 'thead', 'tbody', 'tr', 'th', 'td', 'a', 'img'
        ]);

        const DEFAULT_ALLOWED_ATTRIBUTES = new Set([
            'id', 'class', 'style', 'title', 'role', 'data-', 'aria-',
            'href', 'target', 'rel', 'src', 'alt', 'width', 'height',
            'summary', 'scope', 'colspan', 'rowspan', 'cite'
        ]);

        function renderToDOM(node, options = {}) {
            const { data = {}, allowedTags = DEFAULT_ALLOWED_TAGS, allowedAttributes = DEFAULT_ALLOWED_ATTRIBUTES } = options;
            
            if (node && typeof node === 'object' && '$template' in node && '$data' in node) {
                return renderToDOM(node.$template, { ...options, data: node.$data });
            }

            const fragment = document.createDocumentFragment();
            const elements = renderNode(node, data, allowedTags, allowedAttributes);
            
            if (Array.isArray(elements)) {
                elements.forEach(el => fragment.appendChild(el));
            } else {
                fragment.appendChild(elements);
            }

            return fragment;
        }

        function renderNode(node, data, allowedTags, allowedAttributes) {
            if (typeof node === 'string') {
                const interpolated = interpolate(node, data);
                return document.createTextNode(interpolated);
            }

            if (Array.isArray(node)) {
                return node.flatMap(child => {
                    const rendered = renderNode(child, data, allowedTags, allowedAttributes);
                    return Array.isArray(rendered) ? rendered : [rendered];
                });
            }

            if (typeof node === 'object' && node !== null) {
                return renderElement(node, data, allowedTags, allowedAttributes);
            }

            return document.createTextNode('');
        }

        function renderElement(element, data, allowedTags, allowedAttributes) {
            const entries = Object.entries(element);
            if (entries.length !== 1) {
                throw new Error('Element must have exactly one tag');
            }

            const [tagName, content] = entries[0];

            if (!allowedTags.has(tagName)) {
                throw new Error(`Tag "${tagName}" is not allowed`);
            }

            if (typeof content === 'object' && content !== null && !Array.isArray(content) && '$bind' in content) {
                const bindPath = content.$bind;
                const boundData = getPropertyPath(data, bindPath);
                
                if (Array.isArray(boundData)) {
                    const template = { ...content };
                    delete template.$bind;
                    return boundData.map(item => 
                        renderElement({ [tagName]: template }, item, allowedTags, allowedAttributes)
                    );
                } else {
                    const template = { ...content };
                    delete template.$bind;
                    return renderElement({ [tagName]: template }, boundData, allowedTags, allowedAttributes);
                }
            }

            const domElement = document.createElement(tagName);
            const { attributes, children } = parseContent(content);

            setAttributes(domElement, attributes, data, allowedAttributes);

            children.forEach(child => {
                const childNodes = renderNode(child, data, allowedTags, allowedAttributes);
                if (Array.isArray(childNodes)) {
                    childNodes.forEach(node => domElement.appendChild(node));
                } else {
                    domElement.appendChild(childNodes);
                }
            });

            return domElement;
        }

        function parseContent(content) {
            if (typeof content === 'string') {
                return { attributes: {}, children: [content] };
            }

            if (Array.isArray(content)) {
                return { attributes: {}, children: content };
            }

            if (typeof content === 'object' && content !== null) {
                const attributes = {};
                let children = [];

                for (const [key, value] of Object.entries(content)) {
                    if (key === '$children') {
                        children = Array.isArray(value) ? value : [value];
                    } else if (!key.startsWith('$')) {
                        attributes[key] = value;
                    }
                }

                return { attributes, children };
            }

            return { attributes: {}, children: [] };
        }

        function setAttributes(element, attributes, data, allowedAttributes) {
            for (const [key, value] of Object.entries(attributes)) {
                if (value === undefined || key.startsWith('$')) continue;

                const isAllowed = allowedAttributes.has(key) || 
                                 [...allowedAttributes].some(pattern => 
                                   pattern.endsWith('-') && key.startsWith(pattern)
                                 );
                
                if (!isAllowed) {
                    throw new Error(`Attribute "${key}" is not allowed`);
                }

                const interpolatedValue = typeof value === 'string' 
                    ? interpolate(value, data)
                    : String(value);
                
                element.setAttribute(key, interpolatedValue);
            }
        }

        function interpolate(template, data) {
            return template.replace(/\{\{(\{*)(.*?)\}(\}*)\}\}/g, (match, openBraces, content, closeBraces) => {
                const braceCount = openBraces.length;
                
                if (braceCount > 0) {
                    return `{{${openBraces.slice(1)}${content}}${closeBraces.slice(1)}}`;
                } else {
                    const value = getPropertyPath(data, content.trim());
                    return value !== undefined ? String(value) : '';
                }
            });
        }

        function getPropertyPath(obj, path) {
            if (!path) return obj;
            return path.split('.').reduce((current, key) => {
                return current && typeof current === 'object' ? current[key] : undefined;
            }, obj);
        }

        // Demo examples
        try {
            // Hello World
            document.getElementById('hello-world').appendChild(
                renderToDOM({ div: "Hello world" })
            );

            // Card Example
            document.getElementById('card-example').appendChild(
                renderToDOM({
                    div: {
                        class: "card",
                        $children: ["Hello from a card!"]
                    }
                })
            );

            // Data Binding
            document.getElementById('data-binding').appendChild(
                renderToDOM(
                    {
                        div: {
                            class: "user-card",
                            $children: [
                                { h2: "{{name}}" },
                                { p: "{{email}}" }
                            ]
                        }
                    },
                    { data: { name: "Alice Johnson", email: "alice@example.com" } }
                )
            );

            // Array Binding
            document.getElementById('array-binding').appendChild(
                renderToDOM(
                    {
                        ul: {
                            $bind: "products",
                            $children: [
                                { li: "{{name}} â€” {{price}}" }
                            ]
                        }
                    },
                    {
                        data: {
                            products: [
                                { name: "Laptop", price: "$999" },
                                { name: "Phone", price: "$499" },
                                { name: "Tablet", price: "$299" }
                            ]
                        }
                    }
                )
            );

            // Self-contained
            document.getElementById('self-contained').appendChild(
                renderToDOM({
                    $template: {
                        div: {
                            class: "product-card",
                            $children: [
                                { h2: "{{name}}" },
                                { p: "Only {{price}}!" }
                            ]
                        }
                    },
                    $data: {
                        name: "Gaming Laptop",
                        price: "$1299"
                    }
                })
            );

            // Mixed Content
            document.getElementById('mixed-content').appendChild(
                renderToDOM({
                    div: {
                        $children: [
                            "Hello ",
                            { span: { style: "color: blue;", $children: ["World"] } },
                            "!"
                        ]
                    }
                })
            );

        } catch (error) {
            console.error('Demo error:', error);
        }

        // Security Demo
        try {
            document.getElementById('security-demo').appendChild(
                renderToDOM({ script: "alert('XSS')" })
            );
        } catch (error) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = `Security check passed: ${error.message}`;
            document.getElementById('security-demo').appendChild(errorDiv);
        }
    </script>
</body>
</html>